<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF : Ensembles d'adresses (&quot;Pools&quot;) et Partage de Charge</title>

<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, 2004 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../fr/index.html">
<img alt="[OpenBSD]" height="30" width="141" src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="queueing.html">Précédent : Gestion de La Bande Passante</a>]
[<a href="index.html">Index</a>]
[<a href="tagging.html">Suivant : Balisage de Paquets</a>]

<p>
<h1>
<font color="#e00000">Pools d'Adresses et Partage de Charge</font>
</h1>

<hr>

<h3>Table des Matières</h3>
<ul>
<li><a href="#intro">Introduction</a>
<li><a href="#nat">Pools d'Adresses NAT</a>
<li><a href="#incoming">Partage de Charge Des Connexions Entrantes</a>
<li><a href="#outgoing">Partage de Charge Des Connexions Sortantes</a>
        <ul>
        <li><a href="#outexample">Exemple de Base de Règles</a>
        </ul>
</ul>

<hr>

<a name="intro"></a>
<h2>Introduction</h2>
Un pool d'adresses, constitué de deux adresses ou plus, permet
à un groupe d'utilisateurs une utilisation partagée de ces
adresses. Un tel ensemble peut être utilisé comme adresse
de redirection dans les règles
<a href="rdr.html"><tt>rdr</tt></a>, comme adresse de traduction dans
les règles <a href="nat.html"><tt>nat</tt></a>, et comme
adresse destination dans les options <tt>route-to</tt>, <tt>reply-to</tt>,
<tt>dup-to</tt> et <a href="filter.html">filter</a>.

<p>
Il existe quatre méthodes pour utiliser un pool d'adresses :
<ul>
<li><tt>bitmask</tt> - supprime la partie réseau d'une adresse IP
    (adresse utilisée comme adresse source dans des règles
    <tt>nat</tt> ou adresse destination dans des règles
    <tt>rdr</tt>) et la remplace avec la partie réseau de
    l'adresse correspondante du pool d'adresses.

Exemple : si l'adresse du pool est 192.0.2.1/24 et l'adresse à
modifier est la 10.0.0.50, l'adresse correspondante au niveau du pool
est la 192.0.2.50. Si le pool d'adresses est le bloc 192.0.2.1/25 et
l'adresse à modifier est la 10.0.0.130, alors l'adresse
correspondante au niveau du pool est la 192.0.2.2.

<li><tt>random</tt> - sélectionne aléatoirement une
    adresse du pool.
<li><tt>source-hash</tt> - utilise un hash de l'adresse source pour
    choisir l'adresse du pool à utiliser. Cette méthode
    permet de garantir qu'une adresse source donnée sera
    toujours associée avec la même adresse du pool. La
    clé avec laquelle est alimenté l'algorithme de
    hachage peut être spécifiée en option
    après le mot-clé <tt>source-hash</tt> au format hex
    ou chaîne de caractères. Par défaut,
    <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+4.6">pfctl(8)</a>
    va générer une clé aléatoire à chaque
    fois que la base de règles est chargée.
<li><tt>round-robin</tt> - attribue les adresses du pool
    séquentiellement. C'est la méthode par défaut
    et c'est aussi la seule méthode autorisée lorsque le
    pool d'adresses est spécifié en utilisant une
    <a href="tables.html">table</a>.
</ul>

<p>
Dans tous les cas, à l'exception notable de la méthode
<tt>round-robin</tt>, le pool d'adresses doit être
spécifié sous forme d'un bloc réseau en notation
<a href="http://public.pacbell.net/dedicated/cidr.html">CIDR</a>
(Classless Inter-Domain Routing). La méthode <tt>round-robin</tt>
accepte des adresses individuelles à partir d'une
<a href="macros.html#lists">liste</a> ou d'une <a href="tables.html">table</a>.

<p>
L'option <tt>sticky-address</tt> peut être utilisée
conjointement avec les types de pool <tt>random</tt> et <tt>round-
robin</tt> afin de s'assurer qu'à une adresse source donnée
corresponde toujours la même adresse de redirection.

<a name="nat"></a>
<h2>Pools d'Adresses NAT</h2>
Un pool d'adresses peut être utilisé comme adresse de
traduction dans les règles
<a href="nat.html"><tt>nat</tt></a>. Les adresses source dans chaque
paquet de connexion sont traduites avec une adresse du pool selon la
méthode choisie. Ceci peut être utile dans des situations
où PF doit faire des opérations de NAT pour un
réseau très grand. Etant donné que le nombre de
connexions traduites par adresse de traduction est limité,
l'ajout d'adresses de traduction permettra à la passerelle NAT
d'être ajustée afin d'assurer le service pour un grand nombre
d'utilisateurs.

<p>
Dans l'exemple suivant, un pool de deux adresses est utilisé pour
traduire les paquets sortants. Pour chaque connexion sortante, PF fera
une attribution séquentielle avec rotation selon la
méthode round-robin.
<blockquote>
<tt>
nat on $ext_if inet -&gt; { 192.0.2.5, 192.0.2.10 }
</tt>
</blockquote>

<p>
Cependant, cette méthode a un inconvénient. En effet, des
connexions successives à partir de la même adresse interne
ne seront pas toujours traduites avec la même adresse de
traduction. Ceci peut causer des interférences lors, par exemple,
de la navigation sur des sites web qui utilisent les adresses IP comme
éléments d'identification des utilisateurs. Une approche
alternative consiste à utiliser la méthode <tt>source-
hash</tt>. Ainsi, chaque adresse interne est toujours traduite avec la
même adresse de traduction. Dans ce cas, le pool d'adresses doit
être obligatoirement un bloc réseau en notation
<a href="http://public.pacbell.net/dedicated/cidr.html">CIDR</a>.
<blockquote>
<tt>
nat on $ext_if inet -&gt; 192.0.2.4/31 source-hash
</tt>
</blockquote>

<p>
Cette règle de <tt>nat</tt> utilise le pool d'adresses
192.0.2.4/31 (192.0.2.4 - 192.0.2.5) comme adresse de traduction de
paquets sortants. Chaque adresse interne sera toujours traduite avec la
même adresse de traduction grâce au mot-clé
<tt>source-hash</tt>.

<a name="incoming"></a>
<h2>Partage de Charge Des Connexions
Entrantes</h2>
Des pools d'adresses peuvent aussi être utilisés pour
partager la charge sur les connexions entrantes. Par exemple, des
connexions web entrantes peuvent être partagées entre
serveurs web d'une même ferme :
<blockquote>
<tt>
web_servers = "{ 10.0.0.10, 10.0.0.11, 10.0.0.13 }"<br>
<br>
rdr on $ext_if proto tcp to port 80 -&gt; $web_servers \<br>
&nbsp;&nbsp;&nbsp;&nbsp;round-robin sticky-address
</tt>
</blockquote>

<p>
Les connexions successives seront redirigées vers les serveurs
web selon la méthode round-robin : les connexions à partir
de la même adresse source seront toujours envoyés au
même serveur web. Cette connexion "collante" ("sticky") existera
aussi longtemps qu'il y aura des états faisant
référence à cette connexion. Une fois les
états expirés, la connexion collante expirera aussi. Les
futures connexions à partir de ce hôte seront
redirigés vers le prochain serveur dans le round robin.

<a name="outgoing"></a>
<h2>Partage de Charge Des Connexions Sortantes</h2>
Les pools d'adresses peuvent être utilisés en combinaison
de l'option de filtrage <tt>route-to</tt> pour faire du partage de
charge entre deux ou plusieurs connexions Internet lorsqu'un protocole
de routage multi-lien
(tel que <a href="http://www.rfc-editor.org/rfc/rfc1771.txt">BGP4</a>)
n'est pas disponible. En utilisant <tt>route-to</tt> avec un pool
d'adresses et la méthode <tt>round-robin</tt>, les connexions
sortantes peuvent être distribuées entre plusieurs liens.

<p>
Pour que le partage de charge fonctionne, il faut aussi connaître
l'adresse IP du routeur adjacent sur chaque connexion Internet. Ces
informations sont données à l'option <tt>route-to</tt>
afin de contrôler la destination des paquets sortants.

<p>
L'exemple suivant partage le trafic sortant entre deux connexions
Internet :
<blockquote>
<tt>
lan_net = "192.168.0.0/24"<br>
int_if &nbsp;= "dc0"<br>
ext_if1 = "fxp0"<br>
ext_if2 = "fxp1"<br>
ext_gw1 = "68.146.224.1"<br>
ext_gw2 = "142.59.76.1"<br>
<br>
pass in on $int_if route-to \<br>
&nbsp;&nbsp;&nbsp;{ ($ext_if1 $ext_gw1), ($ext_if2 $ext_gw2) } round-robin \<br>
&nbsp;&nbsp;&nbsp;from $lan_net to any
</tt>
</blockquote>

<p>
L'option <tt>route-to</tt> est utilisée pour le trafic <i>entrant</i>
sur l'interface <i>interne</i> afin de spécifier les interfaces
réseau sur lesquelles le trafic sortant doit être
partagé ainsi que les passerelles respectives de chaque interface
réseau. Il est à noter que l'option <tt>route-to</tt> doit
être présente dans <i>chaque</i> règle de filtrage pour
laquelle le trafic doit être équilibré. Les paquets
de retour seront acheminés vers la même interface externe
à partir de laquelle les paquets d'origine sont ressortis (c'est
ce qui est effectué par les FAIs). Ces paquets de retour seront
ensuite acheminés vers l'interface du réseau interne
normalement.

<p>
Pour s'assurer que les paquets avec une adresse source appartenant
à <tt>$ext_if1</tt> sont toujours acheminés vers
<tt>$ext_gw1</tt> (et, de même, pour <tt>$ext_if2</tt> et
<tt>$ext_gw2</tt>), les deux lignes suivantes doivent être
incluses dans le jeu de règles :
<blockquote>
<tt>
pass out on $ext_if1 route-to ($ext_if2 $ext_gw2) from $ext_if2 \<br>
&nbsp;&nbsp;&nbsp;to any<br>
pass out on $ext_if2 route-to ($ext_if1 $ext_gw1) from $ext_if1 \<br>
&nbsp;&nbsp;&nbsp;to any 
</tt>
</blockquote>

<p>
Enfin, la NAT peut aussi être utilisée sur chaque interface
de sortie :
<blockquote>
<tt>
nat on $ext_if1 from $lan_net -&gt; ($ext_if1)<br>
nat on $ext_if2 from $lan_net -&gt; ($ext_if2)
</tt>
</blockquote>

<a name="outexample"></a>
<p>
Voici un exemple complet d'équilibrage de charge du trafic
sortant :

<p>
<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
lan_net = "192.168.0.0/24"
int_if  = "dc0"
ext_if1 = "fxp0"
ext_if2 = "fxp1"
ext_gw1 = "68.146.224.1"
ext_gw2 = "142.59.76.1"

#  nat outgoing connections on each internet interface
nat on $ext_if1 from $lan_net -&gt; ($ext_if1)
nat on $ext_if2 from $lan_net -&gt; ($ext_if2)

#  default deny
block in
block out

#  pass all outgoing packets on internal interface
pass out on $int_if to $lan_net
#  pass in quick any packets destined for the gateway itself
pass in quick on $int_if from $lan_net to $int_if
#  load balance outgoing traffic from internal network. 
pass in on $int_if route-to \
    { ($ext_if1 $ext_gw1), ($ext_if2 $ext_gw2) } round-robin \
    from $lan_net
#  keep https traffic on a single connection; some web applications,
#  especially "secure" ones, don't allow it to change mid-session
pass in on $int_if route-to ($ext_if1 $ext_gw1) \
    proto tcp from $lan_net to port https

#  general "pass out" rules for external interfaces
pass out on $ext_if1
pass out on $ext_if2

#  route packets from any IPs on $ext_if1 to $ext_gw1 and the same for
#  $ext_if2 and $ext_gw2
pass out on $ext_if1 route-to ($ext_if2 $ext_gw2) from $ext_if2
pass out on $ext_if2 route-to ($ext_if1 $ext_gw1) from $ext_if1
</pre>
</td></tr>
</table>

<p>
[<a href="queueing.html">Précédent : Mise en Queue des Paquets
et Gestion des Priorités</a>]
[<a href="index.html">Index</a>]
[<a href="tagging.html">Suivant : Balisage de Paquets</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[back]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: pools.html,v 1.25 ]<br>
$Translation: pools.html,v 1.27 2009/12/15 10:53:51 benoit Exp $<br>
-->
$OpenBSD: pools.html,v 1.23 2009/12/22 17:49:10 ajacoutot Exp $
</small>

</body>
</html> 
