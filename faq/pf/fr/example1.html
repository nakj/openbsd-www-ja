<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF : Exemple : Pare-feu pour réseau domestique ou
            petite société</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, 2004 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../fr/index.html">
<img alt="[OpenBSD]" height="30" width="141" src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="carp.html">Précédent : Haute-disponibilité des pare-feu
avec CARP et pfsync</a>]
[<a href="index.html">Index</a>]

<p>
<h1><font color="#e00000">PF : Exemple : Pare-feu pour réseau domestique
    ou petite société</font></h1> <hr>

<h3>Table des Matières</h3>
<ul>
<li><a href="#scenario">Le Scenario</a>
        <ul>
        <li><a href="#network">Le Réseau</a>
        <li><a href="#objective">Les Objectifs</a>
        <li><a href="#prep">Préparation</a>
        </ul>
<li><a href="#ruleset">Le Jeu de Règles</a>
        <ul>
        <li><a href="#macros">Macros</a>
        <li><a href="#options">Options</a>
        <li><a href="#scrub">Scrub</a>
        <li><a href="#nat">Traduction d'Adresses Réseau</a>
        <li><a href="#rdr">Redirection</a>
        <li><a href="#filter">Règles de Filtrage</a>
        </ul>
<li><a href="#allrules">Le Jeu de Règles Complet</a>
</ul>

<hr>

<a name="scenario"></a>
<h2>Le Scenario</h2>
Dans cet exemple, PF fonctionne sur une machine OpenBSD jouant le rôle
de pare-feu et de passerelle NAT pour un réseau SoHo. L'objectif global
est de fournir un accès Internet au réseau local, de fournir un accès
limité au pare-feu depuis Internet et d'exposer un serveur web interne
à l'Internet. Ce document a pour but de vous montrer comment on
construit un jeu de règles correspondant à l'objectif précité.

<a name="network"></a>
<h3>Le Réseau</h3>
Le réseau est conçu de la manière suivante :

<pre>
    
  [ COMP1 ]    [ COMP3 ]
      |            |                               
   ---+------+-----+------- xl0 [ OpenBSD ] fxp0 -------- ( Internet )
             |
         [ COMP2 ]

</pre>

<p>
Il y a un certain nombre de machines sur le réseau interne. Le diagramme
en montre trois mais le vrai nombre n'est pas une donnée utile. Ces
machines sont des stations de travail normales servant à surfer sur le
web, écrire des messages électroniques, participer à des forums de
discussion en ligne, etc à l'exception de COMP3 qui sert aussi de
serveur Web. Le réseau interne utilise le bloc de réseau
192.168.0.0 / 255.255.255.0.

<p>
Le pare-feu OpenBSD est une machine dotée d'un Celeron 300 et de deux
cartes réseau : une 3Com 3c905B (<tt>xl0</tt>) et une Intel
EtherExpress Pro/100 (<tt>fxp0</tt>). Le pare-feu a une connexion câble
vers Internet et utilise la NAT pour partager cette connexion avec le
réseau interne. L'adresse IP de l'interface externe est attribuée
dynamiquement par le Fournisseur d'Accès Internet.

<a name="objective"></a>
<h3>Les Objectifs</h3>
Les objectifs sont les suivants :
<ul>
<li>Fournir un accès Internet sans restriction pour chaque machine du
    réseau interne.
<li>Utiliser un jeu de règles bloquant tout flux par défaut.
<li>Autoriser les flux entrants suivants sur le pare-feu à partir
    d'Internet :
        <ul>
        <li>SSH (port TCP 22) : utilisé pour la maintenance externe du
            pare-feu.
        <li>Auth/Ident (port TCP 113): utilisé par quelques services
            tels que SMTP et IRC.
        <li>Messages ICMP "Echo Request" : Le type de paquet ICMP
            utilisé par
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&amp;sektion=8">ping(8)</a>.
        </ul>
<li>Rediriger les tentatives de connexion sur le port TCP 80 (qui sont
    des tentatives d'accès à un serveur Web) vers la machine COMP3. Et
    autoriser aussi le trafic vers le port TCP 80 destiné à COMP3 à
    travers le pare-feu.
<li>Enregistrer des statistiques de filtrage pour l'interface externe.
<li>Par défaut, renvoyer un RST TCP ou un message ICMP "Unreachable"
    pour les paquets bloqués.
<li>S'assurer que le jeu de règles est aussi simple et facile à
    maintenir que possible.
</ul>

<a name="prep"></a>
<h3>Préparation</h3>
Ce document suppose que l'hôte OpenBSD a été correctement configuré
pour fonctionner comme routeur : configuration réseau, connexion
Internet et positionnement des variables 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&amp;sektion=3"
>sysctl(3)</a> <tt>net.inet.ip.forwarding</tt> et/ou
<tt>net.inet6.ip6.forwarding</tt> à "<tt>1</tt>".
Vouc devez également activer PF en utilisant
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+4.6"
>pfctl(8)</a> ou en définissant la variable appropriée dans
<tt>/etc/rc.conf.local</tt>.
PF est activé par défaut sur OpenBSD 4.6 et les nouvelles versions.

<a name="ruleset"></a>
<h2>Le Jeu de Règles</h2>
Les sections ci-après détaillent la manière dont le jeu de règles
répondra aux objectifs précités.

<a name="macros"></a>
<h3>Macros</h3>
Les macros suivantes sont définies pour rendre la maintenance et la
lecture du jeu de règles plus faciles :
<blockquote>
<tt>
ext_if="fxp0"<br>
int_if="xl0"<br>
<br>
tcp_services = "{ 22, 113 }"<br>
icmp_types = "echoreq"<br>
<br>
comp3 = "192.168.0.3"
</tt>
</blockquote>

<p>
Les deux premières lignes définissent les interfaces réseau sur
lesquelles le filtrage sera effectué. En les définissant ici, si nous
devons déplacer ce système vers une autre machine avec un matériel
différent, nous pourrons alors ne changer que ces deux lignes et le
reste des règles restera valable. Les troisièmes et quatrièmes lignes
listent les numéros de port TCP des services ouverts depuis Internet
(SSH et ident/auth) et les types de paquets ICMP qui sont autorisés à
parvenir jusqu'aù pare-feu. Enfin, la dernière ligne définit l'adresse
IP de COMP3.

<p>
<b>Remarque</b> : Si la connexion Internet nécessite l'utilisation
   de
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pppoe&amp;sektion=8">PPPoE</a>, 
   le filtrage et la NAT s'effectueront sur l'interface <tt>tun0</tt> <i>au
   lieu de</i> <tt>fxp0</tt>.

<a name="options"></a>
<h3>Options</h3>
Les deux options suivantes spécifient la réponse par défaut fournie par
les règles de filtrage <tt>block</tt> et activent la collecte de
statistiques sur l'interface externe :
<blockquote>
<tt>
set block-policy return<br>
set loginterface $ext_if
</tt>
</blockquote>

<p>
Chaque système Unix possède une interface de "loopback".
C'est une interface réseau virtuelle utilisée par les applications pour
converser avec les autres au sein du même système.
Sur OpenBSD, l'interface de bouclage ("loopback") est
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=lo&amp;sektion=4"
>lo(4)</a>.
Le filtrage est communément désactivé sur ces interfaces.
L'utilisation de <a href="options.html#skip">set skip</a> permet
d'accomplir cela.
<blockquote>
<tt>
set skip on lo
</tt>
</blockquote>
Veuillez prendre note que nous n'effectuons pas de filtrage sur le
groupe d'interfaces <tt>lo</tt> entier, de cette manière nous pourrions
rajouter des interfaces de loopback supplémentaire sans avoir à nous
soucier de mettre à jour cette partie de la configuration.

<a name="scrub"></a>
<h3>Scrub</h3>
Il n'y a aucune raison pour ne pas utiliser la normalisation de paquets
recommandée pour tous les paquets entrants. Il suffit d'utiliser la
ligne suivante :

<blockquote>
<tt>
match in all scrub (no-df)
</tt>
</blockquote>

<a name="nat"></a>
<h3>Traduction d'Adresses Réseau</h3>
Pour effectuer la NAT du réseau interne, la règle de <tt>nat</tt>
suivante est utilisée :

<blockquote>
<tt>
nat on $ext_if from !($ext_if) to any -&gt; ($ext_if)
</tt>
</blockquote>

<p>
Dans ce cas, "<tt>!($ext_if)</tt>" pourrait être aisément remplacé par
"<tt>$int_if</tt>" mais si vous ajoutez plusieurs interfaces internes
vous devrez ajouter de nouvelles règles NAT, alors qu'avec cette
structure, NAT sera activé sur toutes les interfaces protégées.

<p>
Vu que l'adresse IP de l'interface externe est attribuée dynamiquement,
des parenthèses sont utilisés autour de l'interface de traduction afin
que PF tienne compte automatiquement des changements d'adresse IP sur
cette interface.

<p>
Puisque nous souhaitons que le proxy FTP fonctionne, nous ajouterons
également <a href="anchors.html">l'ancre</a> NAT :

<blockquote>
<tt>
nat-anchor "ftp-proxy/*"
</tt>
</blockquote>

<a name="rdr"></a>
<h3>Redirection</h3>
La première redirection est pour
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+4.6">ftp-proxy(8)</a> 
afin de permettre aux clients FTP sur le réseau interne de se connecter
à des serveurs FTP sur Internet.
<blockquote>
<tt>
rdr-anchor "ftp-proxy/*"<br>
rdr on $int_if proto tcp from any to any port 21 -&gt; 127.0.0.1 port 8021
</tt>
</blockquote>

<p>
Il est à noter que cette règle ne fonctionnera que pour les connexions
FTP au port 21. Si les utilisateurs se connectent de manière régulière à
des serveurs FTP sur d'autres ports, une liste devra être utilisée pour
spécifier le port de destination, par exemple : <tt>from any to any port
{ 21, 2121 }</tt>.

<p>
La dernière règle de redirection est utilisée pour toutes les tentatives
de connexion sur le port TCP 80 du pare-feu en provenance d'Internet.
Les tentatives légitimes d'accès à ce port seront générées par des
utilisateurs qui essaient d'accèder au serveur web du réseau. Ces
tentatives de connexion doivent être redirigées vers COMP3 :

<blockquote>
<tt>
rdr on $ext_if proto tcp from any to any port 80 -&gt; $comp3
</tt>
</blockquote>

<a name="filter"></a>
<h3>Règles de Filtrage</h3>
Détaillons maintenant les règles de filtrage. Commencez par
l'interdiction par défaut de tout trafic :
<blockquote>
<tt>
block in<br>
</tt>
</blockquote>

<p>
A ce point, tout le trafic entrant sera bloqué même celui en provenance
du réseau interne. Des règles suivantes vont ouvrir un certain
nombre de flux sur le pare-feu afin de répondre aux objectifs précités
et d'ouvrir toutes les interfaces virtuelles nécessaires.

<p>
Gardez à l'esprit que pf peut bloquer le trafic entrant ou sortant d'une
interface.
Cela peut vous simplifier la tâche de ne filtrer que dans une direction
plutôt que d'essayer de rester consistant en filtrant le trafic sortant
et entrant.
Dans notre cas, nous choisirons de filtrer le trafic entrant uniquement,
mais lorsque celui-ci sera permit sur une interface nous ne
l'empêcherons pas d'en sortir. Pour se faire, nous utiliserons :

<blockquote>
<tt>
pass out keep state
</tt>
</blockquote>

<p>
Nous avons besoin d'une <a href="anchors.html">ancre</a> pour
ftp-proxy(8) :
<blockquote>
<tt>
anchor "ftp-proxy/*"
</tt>
</blockquote>

Il est utile d'utiliser la <a href="filter.html#antispoof">protection
contre le spoofing d'adresses</a> :
<blockquote>
<tt>
antispoof quick for { lo $int_if }
</tt>
</blockquote>

<p>
Maintenant, il faut ouvrir les ports utilisés par les services réseau
disponibles depuis Internet. Tout d'abord, le trafic destiné au pare-feu
lui-même :

<blockquote>
<tt>
pass in on $ext_if inet proto tcp from any to ($ext_if) \<br>
&nbsp;&nbsp;&nbsp;port $tcp_services flags S/SA keep state
</tt>
</blockquote>

<p>
La spécification des ports réseau par le biais de la macro
<tt>$tcp_services</tt> rend l'ouverture de nouveaux services pour des
connexions provenant d'Internet plus facile dans la mesure où il suffira
de modifier la macro et recharger le jeu de règles. Des services UDP
peuvent aussi être mis à disposition en créant la macro
<tt>$udp_services</tt> et en ajoutant une règle de filtrage adéquate
similaire à la règle de filtrage ci-dessus en spécifiant <tt>proto
udp</tt>.

<p>
En plus de la règle <tt>rdr</tt> qui fait suivre tout le trafic web vers
COMP3, nous DEVONS aussi autoriser ce trafic à travers le pare-feu :
<blockquote>
<tt>
pass in on $ext_if inet proto tcp from any to $comp3 port 80 \<br>
&nbsp;&nbsp;&nbsp;&nbsp;flags S/SA synproxy state
</tt>
</blockquote>

<p>
Pour un niveau de sécurité plus élevé, nous utilisons
<a href="filter.html#synproxy">TCP SYN Proxy</a> pour améliorer la
protection du web serveur.

<p>
Le trafic ICMP doit être permis :
<blockquote>
<tt>
pass in inet proto icmp all icmp-type $icmp_types keep state
</tt>
</blockquote>

<p>
Comme pour la macro <tt>$tcp_services</tt>, la macro
<tt>$icmp_types</tt> peut facilement être modifiée pour changer les
types des paquets ICMP qui doivent être autorisés à atteindre le 
pare-feu. Notez que cette règle s'applique à toutes les interfaces 
réseau.

<p>
Maintenant, le trafic en provenance du réseau interne doit être
autorisé. Nous supposerons que les utilisateurs du réseau interne savent
ce qu'ils font et ne provoqueront pas de problème sur Internet. Ce n'est
pas nécessairement une bonne supposition pour de nombreux
environnements.
<blockquote>
<tt>
pass in quick on $int_if
</tt>
</blockquote>

<p>
Le trafic TCP, UDP et ICMP à destination d'Internet est autorisé sortir
du pare-feu grâce à la règle précédente "<tt>pass out keep state</tt>".
L'information sur l'état des connexions est sauvegardée pour permettre
aux paquets de retour de passer à leur tour la barrière que constitue le
pare-feu.

<a name="allrules"></a>
<h2>Le Jeu de Règles Complet</h2>
<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
# macros
ext_if="fxp0"
int_if="xl0"

tcp_services = "{ 22, 113 }"
icmp_types = "echoreq"

comp3 = "192.168.0.3"

# options
set block-policy return
set loginterface $ext_if

set skip on lo

# scrub
match in all scrub (no-df)

# nat/rdr
nat on $ext_if from !($ext_if) -> ($ext_if:0)
nat-anchor "ftp-proxy/*"
rdr-anchor "ftp-proxy/*"
rdr pass on $int_if proto tcp to port ftp -> 127.0.0.1 port 8021
rdr on $ext_if proto tcp from any to any port 80 -> $comp3

# règles de filtrage
block in

pass out keep state

anchor "ftp-proxy/*"
antispoof quick for { lo $int_if }

pass in on $ext_if inet proto tcp from any to ($ext_if) \
   port $tcp_services flags S/SA keep state

pass in on $ext_if inet proto tcp from any to $comp3 port 80 \
   flags S/SA synproxy state

pass in inet proto icmp all icmp-type $icmp_types keep state

pass in quick on $int_if
</pre>
</td></tr>
</table>

<p>
[<a href="carp.html">Précédent : Haute-disponibilité des pare-feu
avec CARP et pfsync</a>]
[<a href="index.html">Index</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24"
src="../../../images/back.gif" border="0" alt="[back]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: example1.html,v 1.40 ]<br>
$Translation: example1.html,v 1.38 2010/03/19 05:31:41 benoit Exp $<br>
-->
$OpenBSD: example1.html,v 1.33 2010/03/19 14:01:23 ajacoutot Exp $
</small>

</body>
</html> 
