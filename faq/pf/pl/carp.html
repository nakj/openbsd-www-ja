<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Redundantny firewall z CARP i pfsync</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-2">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf,carp,pfsync">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2005-2007 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../pl/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="authpf.html">[Wstecz: Authpf: pow³oka dla bramek uwierzytelniaj±cych</a>]
[<a href="index.html">Spis tre¶ci</a>]
[<a href="example1.html">Dalej: Zapora ogniowa dla domu i ma³ego biura</a>]

<p>
<h1><font color="#e00000">PF: Redundantny firewall z CARP i pfsync</font></h1>

<hr>

<h3>Spis tre¶ci</h3>
<ul>
<li><a href="#carpintro">Wprowadzenie do CARP</a>
<li><a href="#carpop">Dzia³anie CARP</a>
<li><a href="#carpconfig">Konfiguracja CARP</a>
<li><a href="#carpex">Przyk³ad z CARP</a>
<li><a href="#pfsyncintro">Wprowadzenie do pfsync</a>
<li><a href="#pfsyncop">Dzia³anie pfsync</a>
<li><a href="#pfsyncconfig">Konfiguracja pfsync</a>

<li><a href="#pfsyncex">Przyk³ad z pfsync</a>
<li><a href="#failover">Po³±czenie CARP i pfsync ("failover" oraz
redundancja)</a>
<li><a href="#ops">Zagadnienia zwi±zane z dzia³aniem CARP/pfsync</a>
    <ul>
    <li><a href="#bootconfig">Konfiguracja CARP i pfsync podczas startu</a>
    <li><a href="#forcefail">Wymuszenie przekazania na g³ównej maszynie</a>
    <li><a href="#RulesetTips">Sztuczki z zestawami regu³</a>
    </ul>
<li><a href="#ref">Pozosta³e ¼ród³a</a>
</ul>
		
<hr>

<a name="carpintro"></a>
<h2>Wprowadzenie do CARP</h2>
CARP to Common Address Redundancy Protocol.
Jego podstawowym zadaniem jest dopuszczenie by wiele hostów w tym
samym segmencie sieci mog³o dzieliæ jeden adres IP.
CARP jest bezpieczn± i woln± alternatyw± dla 
<a href="http://www.ietf.org/rfc/rfc3768.txt">Virtual Router Redundancy
Protocol</a> (VRRP)oraz
<a href="http://www.ietf.org/rfc/rfc2281.txt">Hot Standby Router
Protocol</a> (HSRP).

<p>
CARP pracuje pozwalaj±c grupie hostów, w tym samym segmencie sieci, na
dzielenie adresu IP.
Taka grupa hostów nazywana jest "redundancy group".
Taka nadmiarowa grupa posiada przypisany adres IP, który jest dzielony
pomiêdzy cz³onkami grupy.
Wewn±trz grupy jeden host jest przeznaczany jako "g³ówny" (ang. master) 
natomiast pozosta³e jako "zapasowe" (ang. backups).
Host g³ówny jest tym który bie¿±co "trzyma" dzielony adres IP; odpowiada
na ka¿dy ruch i zapytania ARP nadchodz±ce na ten adres.
Ka¿dy host mo¿e nale¿eæ jednocze¶nie do wiêcej ni¿ jednej grupy nadmiarowej.

<p>
Jednym z powszechnych zastosowañ CARP jest tworzenie grupy nadmiarowych
zapór ogniowych. Wirtualny adres IP dedykowany takiej grupie jest ustawiony
na maszynach klienckich jako brama domy¶lna.
W przypadku gdy g³ówny firewall ulednie awarii lub zostanie wy³±czona,
adres IP zostanie przeniesiony na jedn± z zapasowych zapór i obs³uga
bêdzie kontynuowana niezauwa¿alnie. 

<p>
CARP wspiera zarówno IPv4 jak i IPv6.

<a name="carpop"></a>
<h2>Dzia³anie CARP</h2>
G³ówny host w grupie regularnie wysy³a rozg³oszenia do lokalnej sieci,
tak ¿e hosty zapasowe wiedz±, ¿e jest wci±¿ "¿ywy".
Je¿eli hosty zapasowe przestan± otrzymywaæ rozg³oszenia z hosta g³ównego
w ustalonym okresie czasu, jeden z nich przejmuje obowi±zki hosta g³ównego
(jakikolwiek z najni¿sz± skonfigurowan± warto¶ci± parametrów 
<tt>advbase</tt> i <tt>advskew</tt>).

<p>
Istnieje mo¿liwo¶æ by istnia³o wiele grup CARP w tym samym segmencie
sieci.
Rozg³oszenia CARP zawieraj± Virtual Host ID, które pozwala cz³onkom
grup okre¶liæ do jakiej grupy nadmiarowej dane rozg³oszenie nale¿y.

<p>
Aby uniemo¿liwiæ z³o¶liwemu u¿ytkownikowi w segmencie sieci podszywanie
siê pod rozg³oszenia CARP, ka¿da grupa mo¿e byæ skonfigurowana z has³em.
Ka¿dy pakiet CARP wysy³any do grupy jest wtedy chroniony przy u¿yciu
SHA1 HMAC.

<p>
Odk±d CARP jest osobnym protoko³em powinien mieæ sprecyzowan± regu³ê
przepuszczaj±c± w filtrze:

<blockquote>
<tt>
pass out on $carp_dev proto carp keep state
</tt>
</blockquote>

<p>
<tt>$carp_dev</tt> powinien byæ fizycznym interfejsem przez
który komunikuje siê CARP.


<a name="carpconfig"></a>
<h2>konfiguracja CARP</h2>
Ka¿da redundantna grupa jest reprezentowana przez wirtualny interfejs
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=carp&amp;sektion=4&amp;manpath=OpenBSD+4.6"
>carp(4)</a>. Jak dot±d CARP jest konfigurowany korzystaj±c z 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&amp;sektion=8"
>ifconfig(8)</a>.

<blockquote>
<tt>
ifconfig <i>carpN</i> create<br>
<br>
ifconfig <i>carpN</i> vhid <i>vhid</i> [pass <i>password</i>]
[carpdev <i>carpdev</i>] \<br>
&nbsp;&nbsp;&nbsp;[advbase <i>advbase</i>] [advskew <i>advskew</i>]
[state <i>state</i>] <i>ipaddress</i> \<br>
&nbsp;&nbsp;&nbsp;netmask <i>mask</i>
</tt>
</blockquote>

<dl>
<dt><tt><i>carpN</i></tt>

<dd>Nazwa wirtualnego interfejsu cart(4), gdzie <i>N</i> jest
liczb± ca³kowit± reprezentuj±c± numer interfejsu (np. carp10).

<dt><tt><i>vhid</i></tt>
<dd>Virtual Host ID. Jest to unikalny numer s³u¿±cy do
identyfikacji grupy redundantnej od innych wêz³ów w sieci.
Dopuszczalnymi warto¶ciami s± liczby od 1 do 255.

<dt><tt><i>password</i></tt>
<dd>Has³o autoryzacyjne wykorzystywane do komunikacji
z pozosta³ymi hostami CARP w danej grupie.

<dt><tt><i>carpdev</i></tt>
<dd>Opcjonalny parametr okre¶laj±cy fizyczny interfejs który
nale¿y do danej grupy.
Domy¶lnie CARP stara siê okre¶liæ jaki interfejs wykorzystaæ
sprawdzaj±c który fizyczny interfejs znajduje siê w tej samej
podsieci co podane w carp(4) parametry <i>ipaddress</i> i <i>mask</i>

<dt><tt><i>advbase</i></tt>
<dd>Jest to opcjonalny parametr okre¶laj±cy jak czêsto (w sekundach),
rozg³aszaæ ¿e nale¿ymy do grupy.
Warto¶ci± domy¶ln± jest 1 sekunda.
Dopuszczalnymi warto¶ciami s± liczby od 1 do 255.

<dt><tt><i>advskew</i></tt>
<dd>Opcjonalny parametr okre¶laj±cy jak bardzo zniekszta³ciæ
<tt><i>advbase</i></tt>  przy wysy³aniu rozg³oszenia CARP.
Poprzez manipulacjê parametrem <tt><i>advskew</i></tt> 
mo¿emy wybieraæ g³ówny host CARP.
Im wy¿sza jest jego warto¶æ, tym <i>mniej</i> bêdzie dany host
preferowany przy wyborze nastêpnego hosta g³ównego.
Warto¶æ domy¶lna to 0.
Dopuszczalne warto¶ci: od 0 do 254.

<dt><tt><i>state</i></tt>
<dd>Wymusza okre¶lony stan na interfejsie cart(4). Poprawne stany
to <tt>init</tt>, <tt>backup</tt>, i <tt>master</tt>.

<dt><tt><i>ipaddress</i></tt>
<dd>Jest to wspó³dzielony adres IP przeznaczony dla grupy redundantnej.
Adres ten nie musi nale¿eæ do tej samej podsieci co adres IP na
fizycznym interfejsie (je¿eli jest podany)

<dt><tt><i>mask</i></tt>
<dd>Netmaska podsieci wspó³dzielonego IP.
</dl>

<p>
Poni¿sze zachowania CARP s± ustawiane przez 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&amp;sektion=8"
>sysctl(8)</a>.


<dl>
<dt><tt>net.inet.carp.allow</tt>
<dd>Akceptuj lub nie nadchodz±ce pakiety CARP. Domy¶lnie jest 1 (tak).

<dt><tt>net.inet.carp.preempt</tt>
<dd>Zezwala hostom wewn±trz grupy by posiada³y lepsze <tt>advbase</tt>
oraz <tt>advskew</tt> by przy¶pieszyæ wybór hosta g³ównego.
Dodatkowo opcja ta w³±cza automatyczne awaryjne prze³±czenie dla wszystkich 
interfejsów na wypadek awarii jednego z nich.
Je¿eli fizyczny interfejs na którym w³±czony jest CARP padnie, CARP
zmieni <tt>advskew</tt> na 240 na wszystkich pozosta³ych interfejsach,
w istocie, sam siebie prze³±cza awaryjnie.
Opcja ta domy¶lnie ustawiona jest na 0 (wy³±czona).

<dt><tt>net.inet.carp.log</tt>

<dd>Loguje z³e pakiety CARP. Domy¶lnie jest 0 (wy³±czone).

<dt><tt>net.inet.carp.arpbalance</tt>
<dd>Rozk³ada obci±¿enie ruchu poprzez wiele hostów w grupie.
Domy¶lnie jest 0 (wy³±czone).

Wiêcej informacji znajdziesz w
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=carp&amp;sektion=4&amp;manpath=OpenBSD+4.6"
>carp(4)</a>.
</dl>


<a name="carpex"></a>
<h2>Przyk³ad CARP</h2>
Przyk³ad konfiguracji CARP-a:

<blockquote>
<tt>
# sysctl -w net.inet.carp.allow=1<br>

# ifconfig carp1 create<br>
# ifconfig carp1 vhid 1 pass mekmitasdigoat carpdev em0 \<br>
&nbsp;&nbsp;&nbsp;&nbsp;advskew 100 10.0.0.1 netmask 255.255.255.0<br>
</tt>
</blockquote>

<p>
Ustawienia te powoduj±:
<ul>
<li>W³±czenie obs³ugi pakietów CARP (jest to domy¶lne ustawienie).
<li>Utworzenie interfejsu carp(4), <tt>carp1</tt>.
<li>Skonfigurowanie <tt>carp1</tt> dla wirtualnego hosta #1, w³±czenie
has³a, ustawienie <tt>em0</tt> jako fizycznego interfejsu nale¿±cego
do grupy oraz ustawienie tego hosta jako zapasowego poprzez ustawienie
<tt>advskew</tt> na <tt>100</tt> (zak³adaj±c oczywi¶cie, ¿e host g³ówny jest
ustawiony z <tt>advskew</tt> mniejsz± ni¿ 100).
Wspó³dzielone IP przypisane do tej grupy to 10.0.0.1/255.255.255.0.
</ul>

<p>
Uruchomienie <tt>ifconfig</tt> dla <tt>carp1</tt> poka¿e status
tego interfejsu.

<blockquote>
<tt>
# ifconfig carp1<br>
carp1: flags=8802&lt;UP,BROADCAST,SIMPLEX,MULTICAST&gt; mtu 1500<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;carp: BACKUP carpdev em0 vhid 1 advbase 1
advskew 100<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;groups: carp<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inet 10.0.0.1 netmask 0xffffff00 broadcast
10.0.0.255
</tt>
</blockquote>


<a name="pfsyncintro"></a>
<h2>Wprowadzenie do pfsync</h2>

Interfejs sieciowy 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfsync&amp;sektion=4&amp;manpath=OpenBSD+4.6"
>pfsync(4)</a> ujawnia pewne zmiany wykonane w tabeli stanów
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4&amp;manpath=OpenBSD+4.6"
>pd(4)</a>.
Monitoruj±c to urz±dzenie przy pomocy
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&amp;sektion=8"
>tcpdump(8)</a>, mo¿emy w czasie rzeczywistym obserwowaæ zmiany w tabeli stanów.
Ponadto interfejs pfsync(4) pozwala wysy³aæ wiadomo¶ci ze zmiany stanów,
w ten sposób pozosta³e stacje z pracuj±cym PF mog± w³±czaæ te zmiany
do w³asnych tablic stanów.
Podobnie pfsync(4) mo¿e nas³uchiwaæ w sieci na nadchodz±ce wiadomo¶ci.

<a name="pfsyncop"></a>
<h2>Dzia³anie pfsync</h2>
Domy¶lnie pfsync(4) nie wysy³a i nie odbiera z sieci uaktualnieñ
tablicy stanów; jednak¿e, uaktualnienia mog± byæ wci±¿ monitorowane
przy pomocy tcpdump(8) lub innego narzêdzia uruchomionego na lokalnej
maszynie.

<p>
Gdy pfsunc(4) jest ustawiony na wysy³anie i odbieranie uaktualnieñ,
domy¶lnym zachowaniem jest wysy³anie mutlicastowe uaktualnieñ.
Wszystkie uaktualnienia wysy³ane s± bez uwierzytelniania.
Najlepszymi powszechnymi praktykami s±:

<ol>
<li>Po³±czenie dwóch stacji tak by wymienia³y aktualizacje back-to-back
korzystaj±c z kabla krosowanego i wykorzystanie tego interfejsu jako
<tt>syncdev</tt> (zobacz <a href="#pfsyncconfig">poni¿ej</a>).
<li>Wykorzystanie opcji <tt>syncpeer</tt> w ifconfig(8) (zobacz <a href="#pfsyncconfig">poni¿ej</a>)
tak ¿e aktualizacje s± kierowane bezpo¶rednio do peera, nastêpnie
skonfigurowanie
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ipsec&amp;sektion=4">ipsec(4)</a>
pomiêdzy hostami do zabezpieczenia ruchu z pfsync(4).
</ol>

<p>
Kiedy aktualizacje s± wysy³ane i odbierane, pakiety pfsync
powinny byæ przepuszczane przez regu³y filtra:

<blockquote>
<tt>
pass on $sync_if proto pfsync
</tt>
</blockquote>

<p>
<tt>$sync_if</tt> powinien byæ fizycznym interfejsem przez
który komunikuje siê pfsync(4).


<a name="pfsyncconfig"></a>
<h2>Konfiguracja pfsync</h2>
Poniewa¿ pfsync(4) jest interfejsem wirtualnym, jest konfigurowany przy
pomocy polecenia
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&amp;sektion=8"
>ifconfig(8)</a>. 

<blockquote>
<tt>
ifconfig <i>pfsyncN</i> syncdev <i>syncdev</i> [syncpeer
<i>syncpeer</i>]

</tt>
</blockquote>

<dl>
<dt><tt><i>pfsyncN</i></tt>
<dd>Nazwa interfejsu pfsync(4). Interfejs <tt>pfsync0</tt> jest
dostêpny domy¶lnie w j±drze standardowym <tt>GENERIC</tt>.

<dt><tt><i>syncdev</i></tt>
<dd>Nazwa fizycznego interfejsu wykorzystywanego do wysy³ania
uaktualnieñ pfsync.

<dt><tt><i>syncpeer</i></tt>
<dd>Dodatkowy parametr okre¶laj±cy adres IP hosta z którym
wymieniane s± uaktualnienia pfsync.
Domy¶lnie aktualizacje pfsync wysy³ane s± multicastem do sieci
lokalnej.
Opcja ta nadpisuje domy¶lne zachowanie w zamian wysy³aj±c
uaktualnienia do okre¶lonego hosta: <tt><i>syncpeer</i></tt>.
</dl>

<a name="pfsyncex"></a>
<h2>Przyk³ad pfsync</h2>
Przyk³adowa konfiguracja pfsync:

<blockquote>
<tt>
# ifconfig pfsync0 syncdev em1<br>
</tt>
</blockquote>

Nastêpuje w³±czenie pfsync na interfejsie <tt>em1</tt>.
Wychodz±ce uaktualnienia bêd± wysy³ane mutlicastem do sieci
zezwalaj±c by ka¿dy host móg³ je odebraæ.


<a name="failover"></a>
<h2>Po³±czenie CARP i pfsync (failover oraz redundancja)</h2>
£±cz±c w³a¶ciwo¶ci CARP i pfsync, oraz grupê dwóch lub wiêcej
zapór ogniowych, mo¿na stworzyæ wysoce niezawodny, w pe³ni redundantny
klaster zapór ogniowych.

<dl>
<dt>CARP:
<dd>Utrzymujê automatyczne failover z jednej zapory na inn±.

<dt>pfsync:
<dd>Synchronizuje tablice stanów pomiêdzy wszystkimi zaporami.
W przypadku konieczno¶ci automatycznego prze³±czenia na inn± maszynê,
ruch bêdzie móg³ nastêpowaæ nieprzerwanie przez now± g³ówn± zaporê. 
</dl>

<p>
Przyk³adowy scenariusz.
Dwie zapory, <tt>fw1</tt> i <tt>fw2</tt>.


<pre>
	     +----| WAN/Internet |----+ 
	     |                        |
	  em2|                        |em2   
	  +-----+                  +-----+
	  | fw1 |-em1----------em1-| fw2 |
	  +-----+                  +-----+
	  em0|                        |em0
	     |                        | 
          ---+-------Shared LAN-------+---
</pre>

<p>

Zapory po³±czone s± back-to-back kablem krosowany, na interfejsach
<tt>em1</tt>

Oba po³±czone s± do sieci LAN poprzez interfejsy <tt>em0</tt> oraz
z sieci± WAN/Internet poprzez interfejsy <tt>em1</tt>.

Poni¿ej znajduj± siê wykorzystywane adresy IP:

<ul>
<li>fw1 em0: 172.16.0.1
<li>fw1 em1: 10.10.10.1

<li>fw1 em2: 192.0.2.1
<li>fw2 em0: 172.16.0.2
<li>fw2 em1: 10.10.10.2
<li>fw2 em2: 192.0.2.2
<li>LAN wspó³dzielony IP: 172.16.0.100
<li>WAN/Internet wspó³dzielony IP: 192.0.2.100
</ul>

<p>
Polityka sieci zak³ada ¿e <tt>fw1</tt> bêdzie preferowan± zapor± g³ówn±.

<p>
Konfigurujemy fw1:

<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">

<pre>
! enable preemption and group interface failover
# sysctl -w net.inet.carp.preempt=1

! configure pfsync
# ifconfig em1 10.10.10.1 netmask 255.255.255.0
# ifconfig pfsync0 syncdev em1
# ifconfig pfsync0 up

! configure CARP on the LAN side
# ifconfig carp1 create
# ifconfig carp1 vhid 1 carpdev em0 pass lanpasswd \
    172.16.0.100 netmask 255.255.255.0
     
! configure CARP on the WAN/Internet side
# ifconfig carp2 create
# ifconfig carp2 vhid 2 carpdev em2 pass netpasswd \
    192.0.2.100 netmask 255.255.255.0
</pre>
</td></tr>
</table>

<p>
Konfigurujemy fw2:

<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
! enable preemption and group interface failover
# sysctl -w net.inet.carp.preempt=1

! configure pfsync
# ifconfig em1 10.10.10.2 netmask 255.255.255.0
# ifconfig pfsync0 syncdev em1
# ifconfig pfsync0 up

! configure CARP on the LAN side
# ifconfig carp1 create
# ifconfig carp1 vhid 1 carpdev em0 pass lanpasswd \
    advskew 128 172.16.0.100 netmask 255.255.255.0

! configure CARP on the WAN/Internet side
# ifconfig carp2 create
# ifconfig carp2 vhid 2 carpdev em2 pass netpasswd \
    advskew 128 192.0.2.100 netmask 255.255.255.0
</pre>
</td></tr>
</table>
		  
		  
<a name="ops"></a>
<h2>Zagadnienia zwi±zane z dzia³aniem CARP/pfsync</h2>
Niektóre napotkane zagadnienia zwi±zane z dzia³aniem CARP/pfsync.

<a name="bootconfig"></a>
<h3>Konfiguracja CARP oraz pfsync podczas startu</h3>
Poniewa¿ carp(4) oraz pfsync(4) s± typami interfejsów sieciowych, mog±
byæ konfigurowane podczas startu poprzez utworzenie w³a¶ciwych plików
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=hostname.if&amp;sektion=5"
>hostname.if(5)</a>.
Skrypt startowy 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=netstart&amp;sektion=8"
>netstart</a> zadba o utworzenie interfejsu oraz jego skonfigurowanie.

<p>
Przyk³ad:

<dl>

<dt>/etc/hostname.carp1</dt>
<dd>
inet 172.16.0.100 255.255.255.0 172.16.0.255 vhid 1 carpdev em0 \<br>
&nbsp;&nbsp;&nbsp;&nbsp;pass lanpasswd
</dd>
</dl>

<dl>
<dt>/etc/hostname.pfsync0</dt>
<dd>
up syncdev em1
</dd>
</dl>

<a name="forcefail"></a>
<h3>Wymuszenie przekazania na g³ównej maszynie.</h3>

Mog± wyst±piæ sytuacje w których konieczne bêdzie wy³±czenie lub 
zdegradowanie hosta g³ównego w jakim¶ celu.
Przyk³ad poni¿ej rozpatruje konieczno¶æ wy³±czenia g³ównej zapory
ze wzglêdu na konserwacjê lub wykrycie problemu.
Przedmiotem tutaj jest wdziêczne przekazanie ruchu na jeden z zapasowych
hostów tak by nie mia³o to wp³ywu na u¿ytkowników.

<p>
By przekazaæ ruch dla okre¶lonej grupy CARP, wy³±cz interfejs carp(4) 
na g³ównej zaporze ogniowej. Spowoduje to wys³anie z niej rozg³oszenia 
z "nieskoñczonymi" warto¶ciami <tt>advbase</tt> oraz <tt>advskew</tt>
Host(y) zapasowe zauwa¿± tak± informacjê i natychmiast przejm± zadania
g³ównego.

<blockquote>
<tt>
# ifconfig carp1 down
</tt>
</blockquote>


<p>
Alternatyw± jest zwiêkszenie <tt>advskew</tt> do warto¶ci wiêkszej ni¿
warto¶æ <tt>advskew</tt> na hostach zapasowych. Spowoduje to awaryjne
prze³±czenie, jednak pozwoli hostowi g³ównemu na przynale¿no¶æ do
grupy CARP.

<p>
Inna metod± awaryjnego prze³±czania jest dostrojenie licznika degradacji CARP'a.
Licznik degradacji jest odmierza "kiedy" host staje siê hostem g³ównym 
w grupie CARP.
Przyk³adowo, z³ym pomys³em jest by startuj±cy w³a¶nie host sta³ siê g³ównym
w grupie CARP, a¿ do czasu skonfigurowania wszystkich interfejsów, uruchomienia
wszystkich daemonów, itp.
Hosty rozg³aszaj±ce wysok± warto¶æ degradacji bêd± znacznie mniej preferowanie
w elekcji g³ównego.

<p>
Licznik degradacji przechowywany jest w ka¿dym interfejsie grupy do której
nale¿y dany interfejs.
Domy¶lnie, wszyskie interfejsy CARP nale¿± do grupy interfejsów "carp".
Aktualn± warto¶æ licznika degradacji mo¿na sprawdziæ korzystaj±c z 
polecenia ifconfig(8):
 
<blockquote>
<tt>
# ifconfig -g carp<br>
carp: carp demote count 0
</tt>
</blockquote>

<p>
W tym przyk³adzie pokazana zosta³a zawarto¶æ licznika powi±zanego z 
grup± interfejsów "carp".
Gdy host CARP rozg³asza siê w sieci, bierze sumê liczników degradacji
dla ka¿dej grupy interfejsów carp(4) do których on nale¿y i rozg³asza
t± warto¶æ jako warto¶æ degradacji.

<p>
Rozwa¿my poni¿szy przyk³ad.
Dwie zaporty sieciowe dzia³aj±ce z CARP z poni¿szymi interfejsami CARP:

<ul>
<li>carp1 -- Ksiêgowo¶æ
<li>carp2 -- Normalni pracownicy
<li>carp3 -- Internet
<li>carp4 -- DMZ
</ul>

<p>
Celem jest zapewnienie prze³±czenia tylko grup carp1 i carp2 na drug±
zaporê.

<p>
Najpierw, przydzielmy ka¿dy z nich do nowej grupy, w tym przypadku
nazywanej "internal":

<blockquote>
<tt>
# ifconfig carp1 group internal<br>
# ifconfig carp2 group internal<br>
# ifconfig internal<br>
carp1: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; mtu 1500<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;carp: MASTER carpdev em0 vhid 1 advbase 1
advskew 100<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;groups: carp internal<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inet 10.0.0.1 netmask 0xffffff00 broadcast
10.0.0.255<br>
carp2: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; mtu 1500<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;carp: MASTER carpdev em1 vhid 2 advbase 1
advskew 100<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;groups: carp internal<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inet 10.0.1.1 netmask 0xffffff00 broadcast
10.0.1.255
</tt>
</blockquote>

<p>
Zwiêkszymy teraz warto¶æ licznika degradacji dla grupy "internal"
przy pomocy ifconfig(8):

<blockquote>
<tt>
# ifconfig -g internal<br>
internal: carp demote count 0<br>
# ifconfig -g internal carpdemote 50<br>
# ifconfig -g internal<br>
internal: carp demote count 50<br>
</tt>
</blockquote>

<p>
Teraz nasz firewall prze³±czy siê g³adko z grupami carp1 i carp2 
na drug± maszynê w klastrze wci±¿ pozostaj±c hostem g³ównym dla
carp3 i cart4.
Gdyby drugi firewall zacz±³ siê rozg³aszaæ z degradacj± wiêksz± ni¿ 50,
lub gdy gdy drugi firewall przesta³ siê rozg³aszaæ, wowczas obecna
maszyna sta³a by siê ponownie rolê g³ównej dla carp1 i carp2.

<p>
Aby powróciæ do pierwotnego firewall'a, odwracamy zmiany:

<blockquote>
<tt>
# ifconfig -g internal -carpdemote 50<br>
# ifconfig -g internal<br>
internal: carp demote count 0<br>
</tt>
</blockquote>

<p>
Daemony sieciowe jak
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=bgpd&amp;sektion=8"
>OpenBGPD</a> czy
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sasyncd&amp;sektion=8"
>sasyncd(8)</a> korzystaj± z licznika degradacji aby siê upewniæ, ¿e firewall nie stanie siê
masterem a¿ do czasu nawi±zania sesji BGP i synchronizacji IPsec SA.

<a name="RulesetTips"></a>
<h3>Sztuczki z zestawami regu³</h3>

<b>Filtrowanie fizycznego interfejsu.</b>

Tak daleko jak PF jest rozpatrywany, ruch sieciowy nadchodzi
z fizycznego interfejsu, a nie z wirtualnego interfejsu CARP (tj. <tt>carp0</tt>).
Zatem, pisz swoje regu³y stosownie do tego.
Nie zapominaj ¿e nazwa interfejsu w PF mo¿e byæ zarówno nazw± fizycznego
interfejsu jak i adresu zwi±zanego z tym interfejsem.
Przyk³adowo, poni¿sza regu³a mo¿e byæ poprawna:
<blockquote><tt>
pass in on fxp0 inet proto tcp from any to carp0 port 22
</tt></blockquote>
lecz zast±pienie <tt>fxp0</tt> <tt>carp0</tt> mo¿e dzia³aæ nie tak jak
to zaplanowa³e¶.

<p>
<b>NIE zapominaj</b> zezwalaæ na <tt>proto carp</tt> and <tt>proto
pfsync</tt>!

<p>

<a name="ref"></a>
<h2>Pozosta³e ¼ród³a</h2>

Prosimy zapoznaj siê z innymi ¼ród³ami po wiêcej informacji:

<ul>
<li>
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=carp&amp;sektion=4&amp;manpath=OpenBSD+4.6"
>carp(4)</a>
<li>
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfsync&amp;sektion=4&amp;manpath=OpenBSD+4.6"
>pfsync(4)</a>
<li>
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&amp;sektion=8"
>ifconfig(8)</a>
<li>
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=hostname.if&amp;sektion=5"
>hostname.if(5)</a>
<li>
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf.conf&amp;sektion=5&amp;manpath=OpenBSD+4.6"
>pf.conf(5)</a>
<li>
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifstated&amp;sektion=8"
>ifstated(8)</a>
<li>
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifstated.conf&amp;sektion=5" 
>ifstated.conf(5)</a>
</ul>


<p>
[<a href="authpf.html">Wstecz: Authpf: pow³oka dla bramek uwierzytelniaj±cych</a>]
[<a href="index.html">Spis tre¶ci</a>]
[<a href="example1.html">Dalej: Zapora ogniowa dla domu lub ma³ego biura</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[back]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>

<small>
<!--
Originally [OpenBSD: carp.html,v 1.24 ]<br>
$Translation: carp.html,v 1.23 2009/11/08 19:35:52 tkniaz Exp $<br>
-->
$OpenBSD: carp.html,v 1.21 2009/11/08 22:09:17 tobias Exp $
</small>

</body>
</html>
