<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Przyk³ad: Firewall dla sieci domowej lub ma³ego biura </title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-2">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003-2005 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../pl/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="carp.html">Wstecz: Redundantny firewall z CARP i pfsync</a>]
[<a href="index.html">Spis tre¶ci</a>]

<p>
<h1><font color="#e00000">PF: Przyk³ad: Firewall dla sieci domowej lub
ma³ego biura</font></h1>
<hr>

<h3>Spis tre¶ci</h3>
<ul>
<li><a href="#scenario">Wstêp</a>
	<ul>
	<li><a href="#network">Sieæ</a>
	<li><a href="#objective">Za³o¿enia</a>
	<li><a href="#prep">Wymagania</a>
	</ul>
<li><a href="#ruleset">Budowanie zestawu regu³</a>
	<ul>
	<li><a href="#macros">Makra</a>
	<li><a href="#options">Opcje</a>
	<li><a href="#scrub">Normalizacja pakietów</a>
	<li><a href="#nat">Translacja adresów</a>
	<li><a href="#rdr">Przekierowania</a>
	<li><a href="#filter">Regu³ki filtra pakietów</a>
	</ul>
<li><a href="#allrules">Kompletny zestaw regu³</a>
</ul>

<hr>

<a name="scenario"></a>
<h2>Wstêp</h2>
W tym FAQ zostanie omówiony przyk³ad wykorzystania maszyny z OpenBSD i
dzia³aj±cym PF do zbudowania firewalla i bramki NAT dla niewielkiej sieci w
domu lub biurze. G³ównym celem jest udostêpnienie po³±czenia z Internetem
komputerom w sieci wewnêtrznej, a tak¿e umo¿liwienie ograniczonego dostêpu z
Internetu do maszyny spe³niaj±cej rolê ¶ciany ogniowej, oraz udostêpnienie
wewnêtrznego serwera www dla zewnêtrznego internetu. 
Kompletny przyk³ad bêdzie mo¿na znale¼æ na koñcu tego dokumentu.

<a name="network"></a>
<h3>Sieæ</h3>
Topologia sieci wygl±da nastêpuj±co:

<pre>
    
  [ KOMP1 ]    [ KOMP3 ]
      |            |                               
   ---+------+-----+------- xl0 [ OpenBSD ] fxp0 -------- ( Internet )
             |
         [ KOMP2 ]

</pre>

<p>
Do sieci wewnêtrznej przy³±czonych jest kilka maszyn, co prawda na schemacie
zaznaczone s± trzy, ale w tym przypadku ich ilo¶æ nie ma ¿adnego znaczenia.
Komputery te wykorzystywane s± do codziennych zadañ takich jak: przegl±danie
stron www, wysy³anie poczty elektronicznej, rozmów, itd., za wyj±tkiem
KOMP3, który s³u¿y równie¿ jako niewielki serwer WWW.  Przestrzeñ adresowa
sieci wewnêtrznej zawiera siê w bloku 192.168.0.0 / 255.255.255.0.

<p>
Router zbudowany na bazie OpenBSD to komputer z procesorem Celeron 300
i dwiema kartami sieciowymi: 3Com 3c509B (<tt>xl0</tt>) i Intel
EtherExpress Pro/100 (<tt>fxp0</tt>). Po³±czony jest on z Internetem
ethernetowym, a do udostêpniania po³±czenia innym komputerom
wykorzystywany jest NAT. Adres IP dla zewnêtrznego interfejsu uzyskiwany
jest dynamicznie od Dostawcy Us³ug Internetowych.

<a name="objective"></a>
<h3>Za³o¿enia</h3>
Za³o¿enia, którymi nale¿y kierowaæ siê przy budowie regu³ek filtrowania:
<ul>
<li>Umo¿liwienie niczym nieograniczonego dostêpu do Internetu komputerom z sieci
wewnêtrznej.
<li>Zastosowanie regu³ek filtra zapewniaj±cych "domy¶lne blokowanie" ruchu
przychodz±cego.
<li>Przepuszczanie ruchu z Internetu skierowanego do nastêpuj±cych portów:
	
    <ul>
	<li>SSH (TCP port 22): u¿ywany do zdalnej administracji ¶ciany ogniowej.
	<li>Auth/Ident (TCP port 113): u¿ywany przez niektóre us³ugi, takie jak
	SMTP czy IRC.
	<li>ICMP Echo Requests: ten typ pakietów ICMP jest u¿ywany przez
	program <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&amp;sektion=8">
	ping(8)</a>.
    </ul>

<li>Przekierowanie po³±czeñ na porcie 80 protko³u TCP (które s± prób±
po³±czenia siê z serwerem WWW) do komputera KOMP3. A tak¿e przepuszenie
przez firewall ruchu na porcie 80 protoko³u TCP przeznaczonego dla COMP3.
<li>Logowanie statystyk filtra pakietów dla zewnêtrznego interfejsu sieciowego.
<li>Wysy³anie domy¶lnej odpowiedzi TCP RST lub ICMP Unreachable na zablokowane
pakiety.
<li>Stworzenie zestawu regu³, który bêdzie prosty i zrozumia³y.
</ul>

<a name="prep"></a>
<h3>Wymagania</h3>
Podczas pisania tego FAQ przyjêto, ¿e OpenBSD zosta³ poprawnie skonfigurowany
do przysz³ej pracy jako router, w³±czaj±c w to w³a¶ciwe przygotowanie sieci,
po³±czenia z Internetem, oraz ustawienia zmiennych
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&amp;sektion=3">sysctl(3)</a>
<tt>net.inet.ip.forwarding</tt> i/lub <tt>net.inet6.ip6.forwarding</tt> na "<tt>1</tt>".
Musisz mieæ tak¿e uruchomionego PF-a przy pomocy
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+4.6">pfctl(8)</a> 
lub ustawion± w³a¶ciw± zmienn± w <tt>/etc/rc.conf.local</tt>.


<a name="ruleset"></a>
<h2>Budowanie zestawu regu³</h2>
Wykonanie poleceñ zawartych w nastêpuj±cych podrozdzia³ach zaowocuje otrzymaniem
kompletnego zestawu regu³ spe³niaj±cego wszystkie warunki podane powy¿ej.

<a name="macros"></a>
<h3>Makra</h3>
Poni¿sze makra maj± na celu u³atwienie zrozumienia oraz usprawnienie zarz±dzania
zestawem regu³:
<blockquote>
<tt>
ext_if = "fxp0"<br>
int_if = "xl0"<br>
<br>
tcp_services = "{ 22, 113 }"<br>
icmp_types = "echoreq"<br>
<br>
comp3 = "192.168.0.3"
</tt>
</blockquote>

<p>
Pierwsze dwie linie okre¶laj± na jakich interfejsach bêdzie odbywaæ siê
filtrowanie. 
Dziêki zdefiniowaniu ich w tym miejscu, w sytuacji gdy bêdziemy chcieli przenie¶æ 
nasz system na inn± maszynê, z innym sprzêtem, bêdziemy mogli zmieniæ tylko 
te dwie linie, a pozosta³a czê¶æ zestawu regu³ bêdzie wci±¿ u¿yteczna.
Trzecia linia zawiera listê portów TCP (SSH i ident/auth), do
których ruch z Internetu ma byæ przepuszczany. W czwartej linii okre¶lone s±
typy komunikatów ICMP, które bêd± akceptowane przez nasz "firewall".
Ostatnia linia okre¶la adres IP komputera KOMP3.

<p>
<b>Uwaga</b>: Je¶li po³±czenie internetowe odbywa siê poprzez
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pppoe&amp;sektion=8"
>PPPoE</a>, wtedy filtrowanie oraz translacja pakietów odbywaæ siê bêdzie na
interfejsie <tt>tun0</tt> a <i>nie</i> na <tt>fxp0</tt>.

<a name="options"></a>
<h3>Opcje</h3>
Dwie poni¿sze opcje w³±czaj± domy¶lne odpowiedzi na zablokowane pakiety dla
regu³y <tt>block</tt>, a tak¿e zbieranie ró¿nego rodzaju statystyk dla
zewnêtrznego interfejsu sieciowego.
<blockquote>
<tt>
set block-policy return<br>
set loginterface $ext_if
</tt>
</blockquote>

<p>
Ka¿dy system UNIX posiada interfejs pêtli zwrotnej nazywany "loopback". 
Jest to wirtualny interfejs sieciowy u¿ywany przez procesy do komunikacji 
z innymi aplikacjami uruchomionymi w lokalnym systemie. Ca³y ruch na tym 
interfejsie powinien byæ przepuszczany bez ¿adnych ograniczeñ. 
W OpenBSD interfejs "loopback" nazywa siê:
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=lo&amp;sektion=4"
>lo(4)</a>.
Najlepszym pomys³em jest wy³±czenie jakiegokolwiek filtrowania na tym 
interfejsie.
W tym celu skorzystaj z opcji <a href="options.html#skip">set skip</a>.

<blockquote>
<tt>
set skip on lo
</tt>
</blockquote>

Zauwa¿, ¿e wy³±czyli¶my filtrowanie dla ca³ej grupy interfejsów <tt>lo</tt>,
w ten sposób w sytuacji gdy pó¼niej dodamy interfejsy "loopback", nie bêdziemy
musieli siê martwiæ o dodawanie tej opcji do istniej±cego zestawu regu³. 

<a name="scrub"></a>
<h3>Normalizacja pakietów</h3>
Nie istnieje ¿aden wa¿ny powód dla którego nadchodz±ce pakiety nie mia³y by
zostaæ poddane normalizacji. W³±czenie normalizowania pakietów odbywa siê przez
dodanie jednej, prostej linii:
<blockquote>
<tt>
match in all scrub (no-df)
</tt>
</blockquote>

<a name="nat"></a>
<h3>Translacja adresów</h3>
W³±czenie translacji adresów (NAT) dla hostów w sieci wewnêtrznej uzyskuje siê
przez dodanie regu³ki <tt>nat</tt>:
<blockquote>
<tt>
nat on $ext_if from !($ext_if) to any -&gt; ($ext_if)
</tt>
</blockquote>

<p>
Wyra¿enie "<tt>!($ext_if)</tt>", mo¿e byæ oczywi¶cie ³atwo zast±pione przez
"<tt>$int_if</tt>", jednak je¿eli dodasz wiele wewnêtrznych interfejsów, 
bêdziesz musia³ dodaæ wiele regu³ NAT, tymczasem w takim rozwi±zaniu, NAT
bêdzie obs³ugiwany na wszystkich zabezpieczonych interfejsach.

<p>
Jako ¿e adres IP dla zewnêtrznego interfejsu sieciowego jest uzyskiwany
dynamicznie, nazwa interfejsu na którym odbywa siê mapowanie adresów zosta³a
wziêty w nawiasy, dziêki temu PF zostanie powiadomione o ka¿dej zmianie adresu.

<p>
Poniewa¿, chcemy mieæ dzia³aj±ce FTP-proxy, umie¶cimy w naszej konfiguracji
równie¿ <a href="anchors.html">zakotwiczenie</a> NAT:

<blockquote>
<tt>
nat-anchor "ftp-proxy/*"
</tt>
</blockquote>

<a name="rdr"></a>
<h3>Przekierowanie</h3>
Pierwsze przekierowania w tym zestawie regu³ s± dla
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+4.6"
>ftp-proxy(8)</a>, aby klient FTP w sieci lokalnej móg³ bez problemów po³±czyæ
siê z serwerami FTP w Internecie.

<blockquote>
<tt>
rdr-anchor "ftp-proxy/*"<br>
rdr on $int_if proto tcp from any to any port 21 -&gt; 127.0.0.1 port 8021
</tt>
</blockquote>

<p>
Proszê zauwa¿yæ, ¿e regu³ka ta obs³uguje jedynie po³±czenia FTP na porcie 21.
Je¶li zajdzie potrzeba umo¿liwienia korzystania z innych numerów portów,
konieczne bêdzie podanie ich w postaci listy, na przyk³ad:
<tt>from any to any port { 21, 2121}</tt>

<p>
Ostatnia regu³a rdr s³u¿y do przekierowania prób po³±czeñ z portem 80 
protoko³u TCP firewalla. Poprawne po³±czenia z tym portem pochodz±
od u¿ytkowników chc±cych uzyskaæ dostêp do serwera WWW. Po³±czenia te
powinny zostaæ przekierowane do komputera KOMP3:

<blockquote>
<tt>
rdr on $ext_if proto tcp from any to any port 80 -&gt; $comp3
</tt>
</blockquote>

<a name="filter"></a>
<h3>Regu³ki filtra pakietów</h3>
Po ustawieniu NAT i przekierowañ mo¿na przyst±piæ do konfiguracji filtra
pakietów. Filtr bêdzie pracowa³ zgodnie z zasad± "domy¶lnego blokowania":
<blockquote>
<tt>
block in<br>
</tt>
</blockquote>

<p>
W tym miejscu ka¿dy ruch usi³uj±cy wej¶æ przez interfejs bêdzie blokowany, 
nawet ten pochodz±cy z sieci wewnêtrznej. 
Kolejne regu³ki bêd± umo¿liwia³y przej¶cie datagramów zgodnie z 
wytycznymi podanymi wcze¶niej.

<p>
Pamiêtaj, ¿e pf mo¿e zablokowaæ ka¿dy ruch wchodz±cy lub wychodz±cy 
przez interfejs.
Mo¿esz sobie znacznie upro¶ciæ ¿ycie, je¿eli zdecydujesz siê na filtrowanie
ruchu w jednym kierunku, zamiast staraæ siê bezpo¶rednio filtrowaæ pewne 
rzeczy, przepuszczaj±c inne.
W naszym przypadku, zdecydowali¶my siê na filtrowanie przychodz±cego ruchu,
lecz gdy dany ruch zostanie raz przepuszczony przez interfejs, nie bêdziemy
starali siê go blokowaæ. Zatem zrobimy co¶ takiego:

<blockquote>
<tt>
pass out keep state
</tt>
</blockquote>

<p>
Potrzebyjemy mieæ <a href="anchors.html">zakotwiczenie</a> dla ftp-proxy(8):

<blockquote>
<tt>
anchor "ftp-proxy/*"
</tt>
</blockquote>

Dobrze jest <a href="filter.html#antispoof">blokowaæ sfa³szowane adresy</a>
(ang. antispoof):

<blockquote>
<tt>
antispoof quick for { lo $int_if }
</tt>
</blockquote>

<p>
Nastêpna regu³ka otwiera porty dla us³ug, które maj± byæ udostêpnione w
Internecie.
Na pocz±tek ruch który jest kierowany do samego firewall-a:

<blockquote>
<tt>
pass in on $ext_if inet proto tcp from any to ($ext_if) \<br>
&nbsp;&nbsp;&nbsp;port $tcp_services flags S/SA keep state
</tt>
</blockquote>

<p>
Podanie portów w postaci makra <tt>$tcp_services</tt> sprawia, ¿e ³atwo dodaæ
kolejne us³ugi, które maj± zostaæ udostêpnione. Wystarczy wyedytowaæ makro i
ponownie za³adowaæ zestaw regu³. Podobnie sprawa ma siê z us³ugami bazuj±cymi
na protokole UDP, potrzeba tylko utworzyæ makro <tt>$udp_services</tt> i dodaæ
bardzo podobn± regu³kê, jak ta pokazana powy¿ej, z opcj± <tt>proto udp</tt>.

<p>
Dodatkowo, obok regu³y <tt>rdr</tt>, która przekierowuje ruch skierowany do
serwera WWW do komputera KOMP3, konieczne jest przepuszczenie tego ruchu
przez firewall: 
<blockquote>
<tt>
pass in on $ext_if inet proto tcp from any to $comp3 port 80 \<br>
&nbsp;&nbsp;&nbsp;&nbsp;flags S/SA synproxy state
</tt>
</blockquote>

<p>
Aby odrobinê poprawiæ bezpieczeñstwo zastosowano  
<a href="filter.html#synproxy">TCP SYN Proxy</a>, który dodatkowo
zabezpiecza serwer przed atakami z zewn±trz.

<p>
Przepuszczenie pakietów ICMP:
<blockquote>
<tt>
pass in inet proto icmp all icmp-type $icmp_types keep state
</tt>
</blockquote>

<p>
Podobnie jak makro <tt>$tcp_services</tt>, makro <tt>$icmp_types</tt> mo¿e
byæ w ³atwy sposób zmienione by umo¿liwiæ przepuszczanie innych typów pakietów
ICMP przez firewall. Proszê zwróciæ uwagê, ¿e regu³ka ta odnosi siê do
wszystkich interfejsów sieciowych.

<p>
Kolejne regu³ki przepuszczaj± ruch z lub do sieci wewnêtrznej. Przyk³ad zak³ada,
¿e u¿ytkownicy na wewnêtrznym interfejsie dok³adnie wiedz± co robi± i nie bêd±
powodowaæ problemów. To niekoniecznie prawid³owe za³o¿enie, mniejsza swoboda
mo¿e byæ bardziej odpowiednia w wielu przypadkach.

<blockquote>
<tt>
pass in quick on $int_if
</tt>
</blockquote>

<p>
Ruch TCP, UDP i ICMP jest przepuszczany do Internetu, ze wzglêdu na 
wcze¶niejsz± regu³ê "<tt>pass out keep state</tt>".  Informacja o stanie
jest zachowywana, zatem pakiety które s± odpowiedzi±, bêd± przepuszczane
przez firewall.

<a name="allrules"></a>
<h2>Kompletny zestaw regu³</h2>
<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
# makra
ext_if = "xl0"
int_if = "fxp0"

tcp_services = "{ 22, 113 }"
icmp_types = "echoreq"

comp3 = "192.168.0.3"

# opcje
set block-policy return
set loginterface $ext_if

set skip on lo0

# normalizacja datagramów 
match in all scrub (no-df)

# nat/rdr
nat on $ext_if from !($ext_if) -> ($ext_if:0)
nat-anchor "ftp-proxy/*"
rdr-anchor "ftp-proxy/*"

rdr pass on $int_if proto tcp to port ftp -> 127.0.0.1 port 8021
rdr on $ext_if proto tcp from any to any port 80 -> $comp3

# regu³ki filtra pakietów
block in

pass out keep state

anchor "ftp-proxy/*"
antispoof quick for { lo $int_if }

pass in on $ext_if inet proto tcp from any to ($ext_if) \
    port $tcp_services flags S/SA keep state

pass in on $ext_if inet proto tcp from any to $comp3 port 80 \
    flags S/SA synproxy state

pass in inet proto icmp all icmp-type $icmp_types keep state

pass in quick on $int_if
</pre>
</td></tr>
</table>

<p>
[<a href="carp.html">Wstecz: Redundantny firewall z CARP i pfsync</a>]
[<a href="index.html">Spis tre¶ci</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[wstecz]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: example1.html,v 1.39 ]<br>
$Translation: example1.html,v 1.32 2009/11/08 19:35:52 tkniaz Exp $<br>
-->
$OpenBSD: example1.html,v 1.32 2009/11/08 22:09:17 tobias Exp $
</small>

</body>
</html> 
