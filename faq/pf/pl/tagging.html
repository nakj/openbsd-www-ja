<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Znakowanie pakietów (Policy Filtering)</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-2">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003-2007 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../pl/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="pools.html">Wstecz: Pule adresów i kierowanie ruchem</a>]
[<a href="index.html">Spis tre¶ci</a>]
[<a href="logging.html">Dalej: Logowanie</a>]

<p>
<h1><font color="#e00000">PF: Znakowanie pakietów (Policy Filtering)</font></h1>

<hr>

<h3>Spis tre¶ci</h3>
<ul>
<li><a href="#intro">Wprowadzenie</a>
<li><a href="#assign">Przypisywanie znaczników do pakietów</a>
<li><a href="#check">Wykorzystanie zastosowanych znaczników</a>
<li><a href="#policy">Polityka filtrowania</a>
<li><a href="#ethernet">Znaczniki dla ramek ethernetowych</a>
</ul>

<hr>

<a name="intro"></a>
<h2>Wprowadzenie</h2>
"Packet tagging" jest sposobem oznaczania pakietów poprzez nadanie im
wewnêtrznego identyfikatora, który mo¿e byæ wykorzystany w pó¼niejszej
translacji lub filtrowaniu danego pakietu. Wprowadzenie znakowania
umo¿liwia stworzenie "zaufania" pomiêdzy interfejsami oraz okre¶lenie
sposobu w jaki pakiety zosta³y potraktowane przez regu³ki NAT.
Dziêki taggowaniu pakietów mo¿liwe staje siê odej¶cie od filtrowania
opartego na regu³kach i przej¶cie do filtrowania bazuj±cego na polityce
ruchu.

<a name="assign"></a>
<h2>Przypisywanie znaczników do pakietów</h2>
Dodanie znacznika (ang. tag) do pakietu mo¿liwa s³owo kluczowe <tt>tag</tt>:
<blockquote>
<tt>
pass in on $int_if all tag INTERNAL_NET keep state
</tt>
</blockquote>

<p>
Znacznik <tt>INTERNAL_NET</tt> zostanie dodany do ka¿dego pakietu, który
pasuje do powy¿szej regu³y.

<p>
Znacznik mo¿e byæ tak¿e przypisany przy u¿yciu
<a href="macros.html#macros">makr</a>. Na przyk³ad:

<blockquote>
<tt>
name = "INTERNAL_NET"<br>
pass in on $int_if all tag $name keep state
</tt>
</blockquote>

<p>
Istnieje tak¿e zestaw predefiniowanych makr gotowych do u¿ycia.
<ul>
<li><tt>$if</tt> - Interfejs
<li><tt>$srcaddr</tt> - ¬ród³owy adres IP
<li><tt>$dstaddr</tt> - Docelowy adres IP
<li><tt>$srcport</tt> - Port ¼ród³owy 
<li><tt>$dstport</tt> - Port docelowy
<li><tt>$proto</tt> - Protokó³
<li><tt>$nr</tt> - Numer regu³ki
</ul>

<p>
Powy¿sze makra rozwijane s± w trakcie ³adowania zestawu regu³, a NIE
w trakcie ich dzia³ania.

<p>
Packet tagging odbywa siê wg nastêpuj±cych zasad:
<ul>
<li>Raz przypisany tag do pakietu nie jest nigdy usuwany. Mo¿e zostaæ jednak
zast±piony innym znacznikiem.
<li>Zgodnie z powy¿sz± zasad±, pakiet bêdzie posiada³ znacznik nawet je¶li
ostatnia pasuj±ca regu³ka nie bêdzie u¿ywa³a klauzuli <tt>tag</tt>.
<li>Do pakietu mo¿e zostaæ przypisany maksymalnie jeden znacznik.
<li>Znaczniki s± <i>wewnêtrznymi</i> identyfikatorami - oznacza to, ¿e
¿aden tag nie zostanie wys³any wraz z pakietem przez interfejs sieciowy.
<li>Znaczniki mog± mieæ nazwy o d³ugo¶ci do 63 znaków.
W OpenBSD 4.0 i wcze¶niejszych, nazwy znaczników ograniczone by³y do 15 znaków.
</ul>

<p>
Rozwa¿my poni¿szy zestaw regu³ek:
<blockquote>
<tt>
(1) pass in on $int_if tag INT_NET keep state<br>
(2) pass in quick on $int_if proto tcp to port 80 tag \<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INT_NET_HTTP keep state<br>
(3) pass in quick on $int_if from 192.168.1.5 keep state
</tt>
</blockquote>

<p>
<ul>
<li>Pakiety nadchodz±ce do interfejsu <tt>$int_if</tt> otrzymaj±
znacznik <tt>INT_NET</tt> zgodnie z regu³a numer 1.
<li>Pakiety TCP przybywaj±ce do interfejsu <tt>$int_if</tt> do
portu 80 najpierw otrzymaj± tag <tt>INT_NET</tt> zgodnie z regu³a
numer 1, a nastêpnie zostanie on zamieniony przez regu³kê numer 2
na znacznik <tt>INT_NET_HTTP</tt>.
<li>Pakiety przybywaj±ce do interfejsu <tt>$int_if</tt> z hosta 192.168.1.5
bêd± tagowane w jednym z dwóch kierunków.
Je¿eli pakiet jest kierowany do portu 80 TCP, zostanie dopasowany do regu³y
#2 i otagowany <tt>INT_NET_HTTP</tt>.
W innym wypadku pakiet zostanie dopasowany do regu³y #3 i zostanie otagowany
z <tt>INT_NET</tt>.
Poniewa¿ pakiet pasuje do regu³y #1, zastosowany zostanie tag <tt>INT_NET</tt>
i nie zostanie on usuniêty, chyba ¿e nastêpna pasuj±ca regu³a okre¶la tag
(to jest "lepko¶æ" tagu).
</ul>

<p>
Obok regu³ek filtruj±cych znaczniki mog± byæ tak¿e dodawane do pakietów
przez regu³ki NAT, czyli <tt>nat</tt>, <tt>rdr</tt> i <tt>binat</tt>,
poprzez u¿ycie s³owa kluczowego <tt>tag</tt>.

<a name="check"></a>
<h2>Wykorzystanie zastosowanych znaczników</h2>
Aby sprawdziæ czy pakiet posiada znacznik przypisany mu przez jedn± z
poprzednich regu³ nale¿y u¿yæ klauzuli <tt>tagged</tt>:
<blockquote>
<tt>
pass out on $ext_if tagged INT_NET keep state
</tt>
</blockquote>

<p>
Pakiety chc±ce opu¶ciæ interfejs <tt>$ext_if</tt> niezale¿nie od
konieczno¶ci spe³nienia warunków regu³ki musz± posiadaæ znacznik
<tt>INT_NET</tt>. Warunek nie posiadania danego znacznika oznacza
siê operatorem <tt>!</tt>:

<blockquote>
<tt>
pass out on $ext_if ! tagged WIFI_NET keep state
</tt>
</blockquote>

<p>
Regu³y transponuj±ce (<tt>nat</tt>/<tt>rdr</tt>/<tt>binat</tt>) tak¿e mog±
korzystaæ z klucza <tt>tagged</tt> do dopasowywania pakietów.

<a name="policy"></a>
<h2>Polityka filtrowania</h2>
Polityka filtrowania to zupe³nie inne podej¶cie do budowania zestawu regu³
filtruj±cych. Polityka okre¶la jaki zestaw pakietów ma byæ wykorzystany
dla danego rodzaju ruchu sieciowego, a tym samym jakie datagramy maj±
zostaæ przepuszczone, a jakie zablokowane. W odró¿nieniu od tradycyjnego
sposobu filtrowania ruchu, polityka filtrowania wstêpnie klasyfikuje
pakiety na podstawie ¼ród³owego/docelowego adresu IP, numeru portu,
protko³u, itd. Oto przyk³adowa polityka filtrowania:
<ul>
<li>Ruch pochodz±cy z wewnêtrznej sieci LAN (LAN_INET) do Internetu jest
przepuszczany i musi byæ transponowany (LAN_INET_NAT).
<li>Ruch pochodz±cy z wewnêtrznej sieci LAN do DMZ (Strefa
Zdemilitaryzowana) jest przepuszczany (LAN_DMZ).
<li>Pakiety z serwerów Internetowych do DMZ s± przepuszczane (INET_DMZ).
<li>Ruch z Internetu, który zostanie zaakceptowany przez 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=spamd&amp;sektion=8"
>spamd(8)</a> jest przepuszczany (SPAMD).
<li>Ca³y pozosta³y ruch jest zablokowany.
</ul>

<p>
Proszê zauwa¿yæ, ¿e przedstawiona powy¿ej polityka obejmuje <i>ca³y</i>
ruch sieciowy przechodz±cy przez firewall. W nawiasach podane zosta³y
znaczniki przypisywane dla okre¶lonego ruchu.

<p>
Maj±c okre¶lon± politykê filtrowania niezbêdne bêdzie teraz napisanie
odpowiednich regu³ek filtruj±cych oraz NAT, które uwzglêdniaæ bêd±
powy¿sze za³o¿enia i odpowiednio przypisywaæ znaczniki.
<blockquote>
<tt>
rdr on $ext_if proto tcp from &lt;spamd&gt; to port smtp \<br>
&nbsp;&nbsp;&nbsp;tag SPAMD -&gt; 127.0.0.1 port 8025<br>
nat on $ext_if tag LAN_INET_NAT tagged LAN_INET -&gt; ($ext_if)<br>
<br>
block all<br>
pass in on $int_if from $int_net tag LAN_INET keep state<br>
pass in on $int_if from $int_net to $dmz_net tag LAN_DMZ keep state<br>
pass in on $ext_if proto tcp to $www_server port 80 tag INET_DMZ keep state
</tt>
</blockquote>

<p>
Po zdefiniowaniu regu³ek przychodzi pora na okre¶lenie jaki ruch mo¿e zostaæ
przepuszony, a jak ma byæ zablokowany.
<blockquote>
<tt>
pass in &nbsp;quick on $ext_if tagged SPAMD keep state<br>
pass out quick on $ext_if tagged LAN_INET_NAT keep state<br>
pass out quick on $dmz_if tagged LAN_DMZ keep state<br>
pass out quick on $dmz_if tagged INET_DMZ keep state
</tt>
</blockquote>

<p>
Posiadaj±c gotowy zestaw regu³, wprowadzanie wielu zmian odbywa siê tylko
przez dodanie lub odjêcie regu³ek klasyfikuj±cych ruch. Na przyk³ad
je¶li zostanie dodany serwer POP3/SMTP do DMZ, wystarczy dodaæ regu³kê
podobn± do tej:
<blockquote>
<tt>
mail_server = "192.168.0.10"<br>
...<br>
pass in on $ext_if proto tcp to $mail_server port { smtp, pop3 } \<br>
&nbsp;&nbsp;&nbsp;tag INET_DMZ keep state
</tt>
</blockquote>

<p>
Ruch poczty elektronicznej zostanie przepuszczony jako, ¿e nale¿y do
polityki INET_DMZ.

<p>
Kompletny zestaw regu³:
<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
# makra
int_if  = "dc0"
dmz_if  = "dc1"
ext_if  = "ep0"
int_net = "10.0.0.0/24"
dmz_net = "192.168.0.0/24"
www_server = "192.168.0.5"
mail_server = "192.168.0.10"

table &lt;spamd&gt; persist file "/etc/spammers"

# klasyfikacja -- podzia³ pakietów na podstawie polityki filtrowania
# okre¶lonej dla firewalla.
rdr on $ext_if proto tcp from &lt;spamd&gt; to port smtp \
    tag SPAMD -&gt; 127.0.0.1 port 8025
nat on $ext_if tag LAN_INET_NAT tagged LAN_INET -&gt; ($ext_if)

block all
pass in on $int_if from $int_net tag LAN_INET keep state
pass in on $int_if from $int_net to $dmz_net tag LAN_DMZ keep state
pass in on $ext_if proto tcp to $www_server port 80 tag INET_DMZ keep state 
pass in on $ext_if proto tcp to $mail_server port { smtp, pop3 } \
    tag INET_DMZ keep state 

# wprowadzenie w ¿ycie -- przepuszczanie/blokowanie oparte na polityce
# filtrowania okre¶lonej dla firewalla.
pass in  quick on $ext_if tagged SPAMD keep state
pass out quick on $ext_if tagged LAN_INET_NAT keep state
pass out quick on $dmz_if tagged LAN_DMZ keep state
pass out quick on $dmz_if tagged INET_DMZ keep state 
</pre>
</td></tr>
</table>

<a name="ethernet"></a>
<h2>Znaczniki dla ramek ethernetowych</h2>
Znakowanie mo¿e byæ tak¿e przeprowadzone na poziome ramek ethernetowych
je¶li maszyna spe³niaj±ca rolê filtra pakietów jest jednocze¶nie mostem
sieciowym
(<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=bridge&amp;sektion=4"
>bridge(4)</a>). 
Podczas tworzenia regu³ek dla bridge(4) mo¿na wykorzystaæ klauzulê
<tt>tag</tt>, dziêki czemu PF bêdzie móg³ filtrowaæ pakiety na podstawie
adresu MAC ¼ród³owego lub docelowego. Regu³y dla mostów siecowych tworzy siê
narzêdziem 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=brconfig&amp;sektion=8"
>brconfig(8)</a>. Oto przyk³ad:
<blockquote>
<tt>
# brconfig bridge0 rule pass in on fxp0 src 0:de:ad:be:ef:0 \<br>
&nbsp;&nbsp;&nbsp;tag USER1
</tt>
</blockquote>

<p>
Aby wykorzystaæ znacznik <tt>USER1</tt> mo¿na w pliku pf.conf
umie¶ciæ poni¿sz± regu³kê:
<blockquote>
<tt>
pass in on fxp0 tagged USER1
</tt>
</blockquote>

<p>
[<a href="pools.html">Wstecz: Pule adresów i kierowanie ruchem</a>]
[<a href="index.html">Spis tre¶ci</a>]
[<a href="logging.html">Dalej: Logowanie</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[back]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: tagging.html,v 1.18 ]<br>
$Translation: tagging.html,v 1.21 2007/05/09 16:25:26 tkniaz Exp $<br>
-->
$OpenBSD: tagging.html,v 1.20 2007/05/10 12:43:46 saad Exp $
</small>

</body>
</html> 
