<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Logowanie</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-2">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, Nick Holland <nick@openbsd.org>
Copyright (c) 2003-2007 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../pl/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>

<p>
[<a href="tagging.html">Wstecz: Packet Tagging</a>]
[<a href="index.html">Spis tre¶ci</a>]
[<a href="perf.html">Dalej: Wydajno¶æ</a>]

<p>
<h1><font color="#e00000">PF: Logowanie</font></h1>

<hr>

<h3>Spis tre¶ci</h3>
<ul>
<li><a href="#intro"	>Wstêp</a>
<li><a href="#log"	>Logowanie pakietów</a>
<li><a href="#logfile"	>Odczytywanie pliku logów</a>
<li><a href="#filter"	>Selektywne przegl±danie logów</a>
<li><a href="#syslog"	>Logowanie pakietów poprzez syslog</a>
</ul>

<hr>

<a name="intro"></a>
<h2>Wstêp</h2>
Gdy pakiet jest logowany poprzez PF, kopia nag³ówka tego pakietu jest wysy³ana
do interfejsu
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflog&amp;sektion=4&amp;manpath=OpenBSD+4.6"
>pflog(4)</a>, w raz z dodatkowymi informacjami takimi jak nazwa interfejsu przez 
jaki pakiet przeszed³, dzia³aniem jakie podj±³ PF wobec tego pakietu 
(przepuszczenie lub zablokowanie), itp.
pflog(4) pozwala aplikacjom z przestrzeni u¿ytkownika na odebranie
informacji PF-a z kernela.
Je¿eli PF jest w³±czony podczas startu systemu, uruchamiany jest demon
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pflogd&amp;sektion=8&amp;manpath=OpenBSD+4.6"
>pflogd(8)</a>.
Domyslnie pflogd(8) nas³uchuje na interfejsie <tt>pflog0</tt> i zapisuje
zalogowane informacje do pliku <tt>/var/log/pflog</tt>.

<a name="log"></a>
<h2>Logowanie pakietów</h2>
<p>
Po to by logowaæ pakiety przechodz±ce przez PF, musi zostaæ u¿yte s³owo
kluczowe <tt>log</tt> w regu³ach <a href="nat.html">NAT/rdr</a> oraz
<a href="filter.html">filter</a>.
Zwróæ uwagê, ¿e mog± byæ logowane tylko pakiety przepuszczane lub
blokowane; nie mo¿na okre¶liæ regu³y która bêdzie tylko logowa³a pakiety.

<p>
Klucz <tt>log</tt> powoduje, ¿e wszystkie pakiety pasuj±ce do regu³y 
bêd± logowane.
W przypadku gdy regu³a <a href="filter.html#state">tworzy stan</a>,
tylko pierwszy pasuj±cy (ten powoduj±cy utworzenie stanu) bêdzie 
logowany.

<p>
Opcje które mo¿na podaæ dla klucza <tt>log</tt>:

<dl>
<dt><tt>all</tt>
<dd>Spowoduje logowanie wszystkich pasuj±cych pakietów, nie tylko 
pocz±tkowego pakietu.
Przydatne w regu³ach które tworz± stany.

<dt><tt>to <i>pflogN</i></tt>
<dd>Powoduje logowanie okre¶lonych pakietów na podany interfejs pflog(4).
Przyk³adowo, gdy korzystamy z
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=spamlogd&amp;sektion=8"
>spamlogd(8)</a>, ca³y ruch SMTP mo¿e byæ przez PF-a logowany na dedykowanym
interfejsie pflog(4).
Mo¿na wówczas wskazaæ demonowi spamlogd(8) aby nas³uchiwa³ na tym interfejsie.
Pozwoli to na zachowanie logów PF-a czystych z wpisów dotycz±cych ruchu
SMTP, który normalnie nie by³by logowany.
U¿yj 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ifconfig&amp;sektion=8"
>ifconfig(8)</a> do tworzenia interfejsów pflog(4).
Domy¶lny interfejs <tt>pflog0</tt> jest tworzony automatycznie.


<dt><tt>user</tt>
<dd>Powoduje logowanie, ze standardow± informacj±, pakietów 
pochodz±cych/kierowanych do soketu którego w³a¶cicielem
jest uniksowy user-id i group-id (obojêtnie jaki socket jest lokalny).
</dl>

<p>
Opcje podawane s± w nawiasie po kluczu <tt>log</tt>;
wielokrotne opcje mog± byæ oddzielone przecinkiem lub spacj±.

<blockquote>
<tt>
pass in log (all, to pflog1) on $ext_if inet proto tcp to $ext_if port 22 keep state
</tt>
</blockquote>


<a name="logfile"></a>
<h2>Odczytywanie pliku logów</h2>
Plik logów, tworzony przez pflogd jest plikiem o formacie binarnym i
nie mo¿e byæ odczytywany przy pomocy edytora tekstu.
Nale¿y u¿yæ tcpdump do jego odczytu.

<p>
Aby wy¶wietliæ zawarto¶æ pliku logów:
<blockquote>
<tt>
# tcpdump -n -e -ttt -r /var/log/pflog
</tt>
</blockquote>

<p>
Oczywi¶cie przegl±danie pliku pflog przy pomocy tcpdump(8),
<i>nie</i> daje wyników w czasie rzeczywistym. Wy¶wietlanie
logowanych pakietów na bie¿±co mo¿e byæ osi±gniête przy pomocy
interfejsu <tt>pflog0</tt>:
<blockquote>
<tt>
# tcpdump -n -e -ttt -i pflog0
</tt>
</blockquote>

<p>
<font color="#e00000">UWAGA: </font>
Podczas analizowania logów, uwagê nale¿y zwracaæ na szczegó³owe
dekodowanie protoko³ów przez tcpdump (tryb "dok³adny" aktywowany
opcj± <tt>-v</tt>). Dekoder zawarty w programie tcpdump nie ma zbyt
chwalebnej przesz³o¶ci je¶li chodzi o bezpieczeñstwo. Przynajmniej
teoretycznie mo¿liwe jest przeprowadzenie opó¼nionego ataku poprzez
wysy³anie pakietów maj±cych zostaæ zalogowanymi. Jest zalecan± praktyk±,
aby przed rozpoczêciem przegl±dania plików logów w ten sposób,
przenie¶æ je z firewalla na inn± maszynê. 

<p>
Szczególna ostro¿no¶æ powinna byæ zachowana w stosunku do zabezpieczenia
dostêpu do plików logów. Domy¶lnie, pflogd bêdzie zapisywaæ 96 bajtów
pakietu w pliku logów.
Dostêp do logów mo¿e skutkowaæ uzyskaniem dostêpu do wra¿liwych
danych transportowanych w pakietach (jak na przyk³ad nazwy
u¿ytkowników i has³a us³ug
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=telnet&amp;sektion=1"
>telnet(1)</a> lub
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp&amp;sektion=1"
>ftp(1)</a>).

<a name="filter"></a>
<h2>Selektywne przegl±danie logów</h2>
Poniewa¿ logi pflogd(8) s± zapisywane w binarnym formacie tcpdump(8),
wszystkie dostêpne w³a¶ciwo¶ci tego programu mog± byæ wykorzystywane
podczas ich przegl±dania. Na przyk³ad, aby wy¶wietliæ pakiety,
które odpowiadaj± portowi 80, mo¿na u¿yæ takiego polecenia:
<blockquote>
<tt>
# tcpdump -n -e -ttt -r /var/log/pflog port 80
</tt>
</blockquote>

<p>
Aby uzyskaæ jeszcze bardziej precyzyjn± informacjê, mo¿na ograniczyæ wy¶wietlane
dane do konkretnych kombinacji port-host:
<blockquote>
<tt>
# tcpdump -n -e -ttt -r /var/log/pflog port 80 and host 192.168.1.3
</tt>
</blockquote>

<p>
Ta sama technika mo¿e byæ zastosowana podczas odczytu bezpo¶rednio
z interfejsu <tt>pflog0</tt>:
<blockquote>
<tt>
# tcpdump -n -e -ttt -i pflog0 host 192.168.4.2
</tt>
</blockquote>

<p>
Warto podkre¶liæ, ¿e nie ma to wp³ywu na to, które pakiety s± zapisywane w
pliku logów pflogd, a jedynie na to, co jest wy¶wietlane przez t± komendê.

<p>
Standardowe regu³y filtruj±ce 
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=tcpdump&amp;sektion=8"
>tcpdump(8)</a> zosta³y rozszerzone o
dodatkowe mo¿liwo¶ci filtrowania logów pflogd:
<ul>
<li><tt>ip</tt> - ustala rodzinê adresów na IPv4.
<li><tt>ip6</tt> - ustala rodzinê adresów na IPv6.
<li><tt>on <i>int</i></tt> - pakiet, który przeszed³ przez interfejs
<i>int</i>.
<li><tt>ifname <i>int</i></tt> - to samo, co <tt>on <i>int</i></tt>.
<li><tt>ruleset <i>name</i></tt> - <a href="anchors.html">zestaw regu³/zakotwiczenie</a> 
do którego pakiet zosta³ dopasowany.
<li><tt>rulenum <i>num</i></tt> - regu³a, do której zosta³ dopasowany
pakiet mia³a numer <i>num</i>.
<li><tt>action <i>act</i></tt> - akcja podjêta wobec pakietu.
Mo¿liwymi akcjami s± <tt>pass</tt> i <tt>block</tt>.
<li><tt>reason <i>res</i></tt> - powód, dla którego akcja <tt>action</tt>
zosta³a podjêta. Mo¿liwymi powodami s± <tt>match</tt>, <tt>bad-offset</tt>,
<tt>fragment</tt>, <tt>short</tt>, <tt>normalize</tt>,
<tt>memory</tt>, <tt>bad-timestamp</tt>,
<tt>congestion</tt>, <tt>ip-option</tt>, <tt>proto-cksum</tt>,
<tt>state-mismatch</tt>, <tt>state-insert</tt>, <tt>state-limit</tt>,
<tt>src-limit</tt> oraz <tt>synproxy</tt>.
<li><tt>inbound</tt> - pakiety nadchodz±ce.
<li><tt>outbound</tt> - pakiety wychodz±ce.
</ul>

<p>
Przyk³ad:
<blockquote>
<tt>
# tcpdump -n -e -ttt -i pflog0 inbound and action block and on wi0
</tt>
</blockquote>

<p>
Wy¶wietla logi w czasie rzeczywistym, dla nadchodz±cych pakietów, które
zosta³y zablokowane na interfejsie wi0.

<a name="syslog"></a>
<h2>Logowanie pakietów poprzez syslog</h2>
W niektórych sytuacjach jest po¿±dane, aby logi firewalla by³y
dostêpne w formacie ASCII i/lub wysy³ane do zdalnego serwera
gromadz±cego logi. Mo¿e to byæ zrealizowane poprzez ma³y skrypt pow³oki, 
wprowadzenie drobnych zmian w plikach konfiguracyjnych OpenBSD oraz
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=syslogd&amp;sektion=8"
>syslogd(8)</a> - demonie loguj±cym. Syslogd prowadzi logi w formacie
ASCII i jest w stanie przechowywaæ logi na zdalnym serwerze logów.

<p>
Prace rozpoczynamy od napisania poni¿szego skryptu:

<p>
<tt>/etc/pflogrotate</tt>
<pre>
    #!/bin/sh
    PFLOG=/var/log/pflog
    FILE=/var/log/pflog5min.$(date "+%Y%m%d%H%M")
    kill -ALRM $(cat /var/run/pflogd.pid)
    if [ -r $PFLOG ] && [ $(stat -f %z $PFLOG) -gt 24 ]; then
       mv $PFLOG $FILE
       kill -HUP $(cat /var/run/pflogd.pid)
       tcpdump -n -e -ttt -r $FILE | logger -t pf -p local0.info
       rm $FILE
    fi
</pre>

<p>
Przej¶æ do edycji zadañ demona cron dla u¿ytkownika root:
<blockquote>
<tt>
# crontab -u root -e
</tt>
</blockquote>

<p>
Dodaæ dwie nastêpuj±ce linie:
<blockquote>
<tt>
# rotate pf log file every 5 minutes<br>
0-59/5 *       *       *       *       /bin/sh /etc/pflogrotate
</tt>
</blockquote>

<p>
Dodaæ nastêpuj±c± linie do <tt>/etc/syslog.conf</tt>:
<blockquote>
<tt>
local0.info &nbsp;&nbsp;&nbsp;&nbsp;/var/log/pflog.txt
</tt>
</blockquote>

<p>
Dodatkowo, aby prowadziæ logi na zdalnym serwerze przeznaczonym do tego celu,
nale¿y dodaæ nastêpuj±c± linie:
<blockquote>
<tt>
local0.info &nbsp;&nbsp;&nbsp;&nbsp;@syslogger
</tt>
</blockquote>

<p>
Dodatkowo nale¿y upewniæ siê, ¿e host <i>syslogger</i> jest zdefiniowany w pliku
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=hosts&amp;sektion=5"
>hosts(5)</a>.

<p>
Utwórz plik <tt>/var/log/pflog.txt</tt>, aby umo¿liwiæ syslog
dopisywanie do niego logów, oraz nadaj mu takie same uprawnienia jak
plikowi pflog.
<blockquote>
<tt>
# touch /var/log/pflog.txt<br>
# chmod 600 /var/log/pflog.txt
</tt>
</blockquote>

<p>
Zmiany stan± siê aktywne po prze³adowaniu demona syslogd:
<blockquote>
<tt>
# kill -HUP $(cat /var/run/syslog.pid)
</tt>
</blockquote>

<p>
Wszystkie logowane pakiety s± teraz wysy³ane do <tt>/var/log/pflog.txt</tt>.
Je¶li druga linia zosta³a tak¿e dodana, s± one tak¿e wysy³ane do zdalnego
hosta loguj±cego <i>syslogger</i>.

<p>
Skrypt <tt>/etc/pflogrotate</tt> ju¿ dzia³a i zastêpuje
<tt>/var/log/pflog</tt> wiêc rotacja <tt>pflog</tt> dokonywana przez
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=newsyslog&amp;sektion=8"
>newsyslog(8)</a> nie jest ju¿ potrzebna i powinna byæ wy³±czona.
Poniewa¿ <tt>/var/log/pflog.txt</tt> przejmujê zadania
<tt>/var/log/pflog</tt>, jego rotacja powinna byæ aktywowana.
Tak wiêc nale¿y zmieniæ <tt>/etc/newsyslog.conf</tt> w nastêpuj±cy sposób:
<pre>
    #/var/log/pflog       600    3    250    *    ZB /var/run/pflogd.pid
    /var/log/pflog.txt    600    7    *      24
</pre>

<p>
PF bêdzie teraz zapisywa³ logi w formacie ASCII do pliku
<tt>/var/log/pflog.txt</tt>. Odpowiednio ustawiony plik 
<tt>/etc/syslog.conf</tt> sprawi, ¿e dziennik prowadzony bêdzie tak¿e na
zdalnym serwerze logów. Logowanie nie bêdzie natychmiastowe i mo¿e up³yn±æ
oko³o 5-6 minut (przerwa pomiêdzy zadaniami cron), zanim logowane
pakiety pojawi± siê pliku.

<p>
[<a href="tagging.html">Wstecz: Packet Tagging</a>]
[<a href="index.html">Spis tre¶ci</a>]
[<a href="perf.html">Dalej: Wydajno¶æ</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[wstecz]"></a> 
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: logging.html,v 1.38 ]<br>
$Translation: logging.html,v 1.30 2009/11/08 19:35:52 tkniaz Exp $<br>
-->
$OpenBSD: logging.html,v 1.29 2009/11/08 22:09:17 tobias Exp $
</small>
</body>
</html> 
