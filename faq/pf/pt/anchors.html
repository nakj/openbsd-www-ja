<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Âncoras</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003-2007 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../pt/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="options.html">Anterior: Opções em Tempo de Execução</a>]
[<a href="index.html">Conteúdo</a>]
[<a href="queueing.html">Próximo: Enfileiramento de Pacotes e
Priorização</a>]

<p>
<h1><font color="#e00000">PF: Âncoras</font></h1>

<hr>

<h3>Conteúdo</h3>
<ul>
<li><a href="#intro">Introdução</a>
<li><a href="#anchors">Âncoras</a>
<li><a href="#options">Opções de Âncoras</a>
<li><a href="#manip">Manipulação de Âncoras</a>
</ul>

<hr>

<a name="intro"></a>
<h2>Introdução</h2>
Além do conjunto de regras principal, o PF pode ainda avaliar
subconjuntos de regras.
Subconjuntos podem ser manipulados em tempo real através do uso do
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+4.6"
>pfctl(8)</a>, provendo um modo conveniente de alterar um conjunto de
regras ativo de forma dinâmica.
Assim como as <a href="tables.html">tabelas</a> são usadas para guardar
listas dinâmicas de endereços, um subconjunto de regras é usado para
guardar conjuntos dinâmicos de regras de filtragem, <tt>nat</tt>,
<tt>rdr</tt> e <tt>binat</tt>.

<p>
Subconjuntos de regras são vinculados ao conjunto principal
utilizando-se âncoras. Existem quatro tipos de regras <tt>anchor</tt>:
<ul>
<li><tt>anchor <i>nome</i></tt> - avalia todas as regras de
    <a href="filter.html">filtragem</a> na âncora <i><tt>nome</tt></i>
<li><tt>binat-anchor <i>nome</i></tt> - avalia todas as regras de
    <a href="nat.html#binat"><tt>binat</tt></a> na âncora
    <i><tt>nome</tt></i>
<li><tt>nat-anchor <i>nome</i></tt> - avalia todas as regras de
    <a href="nat.html"><tt>nat</tt></a> na âncora <i><tt>nome</tt></i>
<li><tt>rdr-anchor <i>nome</i></tt> - avalia todas as regras de
    <a href="rdr.html"><tt>rdr</tt></a> na âncora <i><tt>nome</tt></i>
</ul>

Âncoras podem ser aninhadas, o que permite ao subconjunto de regras ser
encadeado junto.
Regras de âncora são avaliadas de forma relativa à âncora que as
carregou. Por exemplo, regras de âncora no conjunto de regras principal
criam pontos de referência tendo o conjunto de regras principal como
pai, e regras de âncora carregadas de arquivos chamados através da
diretiva <tt>load anchor</tt> criam pontos de ancoramento tendo aquela
âncora como pai.

<a name="named"></a>
<a name="anchors"></a>
<h2>Âncoras</h2>
Uma âncora é uma coleção de regras de filtragem e/ou tradução, tabelas
e outras âncoras que possuam nomes definidos. Quando o PF encontra uma
regra <tt>anchor</tt> no conjunto de regras principal, ele avalia as
regras contidas no ponto de ancoramento como se estivesse avaliando
regras no conjunto principal.
O processamento então continua no conjunto principal, a menos que o
pacote corresponda a uma regra de filtragem que utilize a opção
<tt>quick</tt> ou a uma regra de tradução dentro da âncora, que nesse
caso será a última regra para o pacote, interrompendo a avaliação das
demais regras tanto na âncora quanto no conjunto de regras principal.

<p>
Por exemplo:
<blockquote>
<tt>
ext_if = "fxp0"<br>
<br>
block on $ext_if all<br>
pass &nbsp;out on $ext_if all keep state<br>
anchor goodguys
</tt>
</blockquote>

<p>
Esse conjunto de regras define uma política "negar por padrão" na
interface <tt>fxp0</tt> para o tráfego que entra e sai.
O tráfego de saída é aceito e uma regra de âncora é criada com o nome
<tt>goodguys</tt>.
Regras podem ser inseridas na âncora de três maneiras:
<ul>
<li>usando uma regra <tt>load</tt>
<li>usando o
    <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+4.6"
    >pfctl(8)</a>
<li>especificando regras na linha do conjunto de regras principal
</ul>

<p>
A regra <tt>load</tt> instrui o <tt>pfctl</tt> a inserir na âncora
especificada as regras lidas de um arquivo texto.
A regra <tt>load</tt> deve ser colocada depois da regra <tt>anchor</tt>.
Exemplo:
<blockquote>
<tt>
anchor goodguys<br>
load anchor goodguys:ssh from "/etc/anchor-goodguys-ssh"
</tt>
</blockquote>

<p>
Para adicionar regras a uma âncora usando o <tt>pfctl</tt>, o seguinte
tipo de comando pode ser usado:
<blockquote>
<tt>
# echo "pass in proto tcp from 192.0.2.3 to any port 22" \<br>
&nbsp;&nbsp;&nbsp;| pfctl -a goodguys -f -
</tt>
</blockquote>

<p>
As regras podem ser salvas e carregadas a partir de arquivos de texto:
<blockquote>
<tt>
# cat &gt;&gt; /etc/anchor-goodguys-www<br>
pass in proto tcp from 192.0.2.3 to any port 80<br>
pass in proto tcp from 192.0.2.4 to any port { 80 443 }<br>
<br>
# pfctl -a goodguys -f /etc/anchor-goodguys-www<br>
</tt>
</blockquote>

<p>
Para carregar regras diretamente do conjunto de regras principal,
coloque as regras de âncora em um bloco delimitado por chaves:

<blockquote>
<tt>
anchor "goodguys" { <br>
&nbsp;&nbsp;&nbsp;pass in proto tcp from 192.168.2.3 to port 22<br>
}
</tt>
</blockquote>

<p>
Âncoras na linha também podem conter mais âncoras.

<blockquote>
<tt>
allow = "{ 192.0.2.3 192.0.2.4 }" <br>
<br>
anchor "goodguys" { <br>
&nbsp;&nbsp;&nbsp;anchor { <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass in proto tcp from 192.0.2.3 to port 80 <br>
&nbsp;&nbsp;&nbsp;} <br>
&nbsp;&nbsp;&nbsp;pass in proto tcp from $allow to port 22<br>
}
</tt>
</blockquote>

Com âncoras na linha, o nome da âncora torna-se opcional.
Note que a âncora aninhada no exemplo acima não tem um nome.
Também note que a macro <tt>$allow</tt> é criada fora da âncora (no
conjunto de regras principal) e é usada dentro da âncora.

<p>
Regras de filtragem e tradução podem ser carregadas na âncora usando a
mesma sintaxe e opções que regras carregadas no conjunto de regras
principal.
Um problema, no entanto, é que, a não ser que você esteja usando âncoras
na linha, quaisquer <a href="macros.html">macros</a> usadas também devem
estar definidas dentro da âncora; macros definidas no conjunto de regras
pai <i>não</i> são visíveis na âncora.

<p>
Uma vez que âncoras podem ser aninhadas, é possível especificar que
todas as âncoras filho dentro de uma âncora especificada sejam
avaliadas:

<blockquote>
<tt>
anchor "spam/*"
</tt>
</blockquote>

<p>
Essa sintaxe faz com que cada regra dentro de cada âncora vinculada
à âncora <tt>spam</tt> seja avaliada.
As âncoras filho são avaliadas em ordem alfabética, mas não são
recursivas.
Âncoras sempre são avaliadas em relação à âncora em que estão definidas.

<p>
Cada âncora, bem como o conjunto de regras principal, existe
separadamente dos outros conjuntos de regras. Operações executadas
em um conjunto de regras, como a liberação de regras, não afetam regras
em outros conjuntos de regras. Além disso, remover um ponto de
ancoramento do conjunto de regras principal não causa a destruição da
âncora ou qualquer âncora filha vinculada a ela. Uma âncora não é
destruída até que todas as suas regras sejam liberadas usando o
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+4.6"
>pfctl(8)</a> e que não existam âncoras filha dentro da âncora.

<a name="options"></a>
<h2>Opções de Âncoras</h2>
Regras <tt>anchor</tt> podem opcionalmente especificar interface,
protocolo, endereço de origem e destino, etiqueta, etc., usando
a mesma sintaxe das regras de filtragem. Quando tais informações
são dadas, regras <tt>anchor</tt> somente são processadas se o
pacote corresponder à definição da regra <tt>anchor</tt>.
Por exemplo:
<blockquote>
<tt>
ext_if = "fxp0"<br>
<br>
block on $ext_if all<br>
pass &nbsp;out on $ext_if all keep state<br>
anchor ssh in on $ext_if proto tcp from any to any port 22<br>
</tt>
</blockquote>

<p>
As regras na âncora <tt>ssh</tt> somente são avaliadas em pacotes TCP
com destino a porta 22, vindos da interface <tt>fxp0</tt>.
As regras são então adicionadas à âncora (<tt>anchor</tt>) da seguinte
forma:
<blockquote>
<tt>
# echo "pass in from 192.0.2.10 to any" | pfctl -a ssh -f -
</tt>
</blockquote>

<p>
Portanto, mesmo que a regra de filtragem não especifique uma interface,
protocolo ou porta, a máquina 192.0.2.10 só pode se conectar via SSH por
causa da definição na regra <tt>anchor</tt>.

<p>
A mesma sintaxe pode ser aplicada em âncoras na linha.

<blockquote>
<tt>
allow = "{ 192.0.2.3 192.0.2.4 }" <br>
<br>
anchor "goodguys" in proto tcp { <br>
&nbsp;&nbsp;&nbsp;anchor proto tcp to port 80 { <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass from 192.0.2.3 <br>
&nbsp;&nbsp;&nbsp;} <br>
&nbsp;&nbsp;&nbsp;anchor proto tcp to port 22 { <br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pass from $allow<br>
&nbsp;&nbsp;&nbsp;} <br>
}
</tt>
</blockquote>


<a name="manip"></a>
<h2>Manipulação de Âncoras</h2>
A manipulação de âncoras é feita via <tt>pfctl</tt>.
Ele pode ser usado para adicionar ou remover regras em uma âncora sem
precisar recarregar o conjunto de regras principal.

<p>
Para listar todas as regras na âncora nomeada <tt>ssh</tt>:
<blockquote>
<tt>
# pfctl -a ssh -s rules
</tt>
</blockquote>

<p>
Para liberar todas as regras de filtragem da mesma âncora:
<blockquote>
<tt>
# pfctl -a ssh -F rules
</tt>
</blockquote>

<p>
Para uma listagem completa de comandos, por favor consulte
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+4.6"
>pfctl(8)</a>.

<p>
[<a href="options.html">Anterior: Opções em Tempo de Execução</a>]
[<a href="index.html">Conteúdo</a>]
[<a href="queueing.html">Próximo: Enfileiramento de Pacotes e
Priorização</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[voltar]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: anchors.html,v 1.27 ]<br>
$Translation: anchors.html,v 1.17 2009/10/18 16:52:52 alan Exp $<br>
-->
$OpenBSD: anchors.html,v 1.16 2009/10/19 09:39:58 ajacoutot Exp $
</small>

</body>
</html>
