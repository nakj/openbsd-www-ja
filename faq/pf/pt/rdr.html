<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Redirecionamento de Tráfego ("Port Forwarding")</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, Nick Holland <nick@openbsd.org>
Copyright (c) 2003-2005, Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../pt/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="nat.html">Anterior: Tradução do Endereço de Rede (NAT)</a>]
[<a href="index.html">Conteúdo</a>]
[<a href="shortcuts.html">Próximo: Atalhos na Criação de
Conjuntos de Regras</a>]

<h1><font color="#e00000">PF: Redirecionamento ("Port Forwarding")</font></h1>

<hr>

<h3>Conteúdo</h3>
<ul>
<li><a href="#intro">Introdução</a>
<li><a href="#filter">Redirecionamento e Filtragem de Pacotes</a>
<li><a href="#security">Implicações de Segurança</a>
<li><a href="#reflect">Redirecionamento e Reflexão</a>
	<ul>
	<li><a href="#splitdns">DNS "Split-Horizon"</a>
	<li><a href="#sepnet">Mover o Servidor Para uma Rede Local
            Separada</a>
	<li><a href="#tcpproxy">Proxy TCP</a>
	<li><a href="#rdrnat">Combinação de RDR e NAT</a>
	</ul>
</ul>

<hr>

<a name="intro"></a>
<h2>Introdução</h2>
Quando você utiliza NAT no seu escritório, você tem a Internet
inteira disponível para todas as suas máquinas.
Mas e se você tiver uma máquina atrás do gateway NAT que precisa ser
acessada de fora? É aqui que entra em cena o redirecionamento.
Redirecionamento permite enviar tráfego para uma máquina atrás do
gateway NAT.

<p>
Vejamos um exemplo:
<blockquote>
<tt>
rdr on tl0 proto tcp from any to any port 80 -&gt; 192.168.1.20
</tt>
</blockquote>

<p>
Essa linha redireciona o tráfego TCP na porta 80 (servidor Web) para uma
máquina na rede com o endereço 192.168.1.20. Portanto, mesmo que
192.168.1.20 esteja atrás do gateway dentro da rede, ela se torna
acessível ao mundo externo.

<p>
A parte <tt>from any to any</tt> da linha <tt>rdr</tt> acima pode ser
muito útil. Se você souber quais endereços ou sub-redes devem ter acesso
ao servidor na porta 80, pode restringi-los assim:
<blockquote>
<tt>
rdr on tl0 proto tcp from 27.146.49.0/24 to any port 80 -&gt; \<br>
&nbsp;&nbsp;&nbsp;192.168.1.20
</tt>
</blockquote>

<p>
Isso redireciona somente a sub-rede especificada. Perceba que isso
implica que você pode redirecionar diferentes máquinas para máquinas
diferentes atrás do gateway. Isso pode ser muito útil. Por exemplo,
você pode fazer com que usuários em lugares remotos acessem seus
próprios computadores desktop usando a mesma porta e o mesmo endereço IP
no gateway desde que você saiba de que endereço IP eles se conectarão:
<blockquote>
<tt>
rdr on tl0 proto tcp from 27.146.49.14 to any port 80 -&gt; \<br>
&nbsp;&nbsp;&nbsp;192.168.1.20<br>
rdr on tl0 proto tcp from 16.114.4.89 to any port 80 -&gt; \<br>
&nbsp;&nbsp;&nbsp;192.168.1.22<br>
rdr on tl0 proto tcp from 24.2.74.178 to any port 80 -&gt; \<br>
&nbsp;&nbsp;&nbsp;192.168.1.23
</tt>
</blockquote>

<p>
Uma faixa de portas também pode ser redirecionada dentro da mesma regra:
<blockquote>
<tt>
rdr on tl0 proto tcp from any to any port 5000:5500 -&gt; \<br>
&nbsp;&nbsp;&nbsp;192.168.1.20<br>
rdr on tl0 proto tcp from any to any port 5000:5500 -&gt; \<br>
&nbsp;&nbsp;&nbsp;192.168.1.20 port 6000<br>
rdr on tl0 proto tcp from any to any port 5000:5500 -&gt; \<br>
&nbsp;&nbsp;&nbsp;192.168.1.20 port 7000:*<br>
</tt>
</blockquote>

<p>
Esses exemplos mostram portas entre 5000 a 5500 (faixa inclusiva)
sendo redirecionadas para 192.168.1.20.
Na primeira regra, a porta 5000 é redirecionada para 5000, 5001 para
5001, etc.
Na segunda regra, toda a faixa de portas é redirecionada para a porta
6000.
E, na última regra, a porta 5000 é redirecionada para 7000, 5001 para
7001, etc.

<a name="filter"></a>
<h2>Redirecionamento e Filtragem de Pacotes</h2>
<font color="#ff0000">NOTA:</font> Pacotes traduzidos ainda devem passar
pelo sistema de filtragem e serão bloqueados ou permitidos com base
nas regras de filtragem que foram definidas.

<p>
A <i>única</i> exceção à regra é quando a palavra-chave <tt>pass</tt>
é usada na regra <tt>rdr</tt>. Nesse caso, os pacotes redirecionados
passam direto pelo sistema de filtragem: as regras de filtragem não
são avaliadas para esses pacotes.
Esse é um atalho para evitar a adição de regras de filtragem
<tt>pass</tt> para cada regra de redirecionamento.
Pense nisso como uma regra <tt>rdr</tt> normal (sem a palavra-chave
<tt>pass</tt>) associada a uma regra de filtragem <tt>pass</tt> com a
palavra-chave <tt>keep state</tt>.
Contudo, caso queira habilitar opções de filtragem mais específicas,
como <tt>synproxy</tt>, <tt>modulate state</tt>, etc., você ainda
precisa usar regras <tt>pass</tt> dedicadas, já que essas opções
não se encaixam em regras de redirecionamento.

<p>
Também fique ciente de que a tradução ocorre <i>antes</i> da
filtragem; o sistema de filtragem vê os pacotes <i>traduzidos</i>
como eles ficam após terem seus endereços IP e/ou portas alterados
para corresponder ao endereço/à porta de redirecionamento
especificado(a) na regra <tt>rdr</tt>.
Considere o cenário:

<ul>
<li>192.0.2.1 - máquina na Internet
<li>24.65.1.13 - endereço externo do roteador OpenBSD
<li>192.168.1.5 - endereço IP interno do servidor Web
</ul>

<p>
Regra de redirecionamento:
<blockquote>
<tt>
rdr on tl0 proto tcp from 192.0.2.1 to 24.65.1.13 port 80 \<br>
&nbsp;&nbsp;&nbsp;-&gt; 192.168.1.5 port 8000
</tt>
</blockquote>

<p>
Pacote antes da regra <tt>rdr</tt> ser processada:
<ul>
<li>Endereço de origem: 192.0.2.1
<li>Porta de origem: 4028 (escolhida aleatoriamente pelo sistema
    operacional)
<li>Endereço de destino: 24.65.1.13
<li>Porta de destino: 80
</ul>

<p>
Pacote após a regra <tt>rdr</tt> ter sido processada:
<ul>
<li>Endereço de origem: 192.0.2.1
<li>Porta de origem: 4028
<li>Endereço de destino: 192.168.1.5
<li>Porta de destino: 8000
</ul>

<p>
O sistema de filtragem vê o pacote IP como ele se encontra após ter
sido feita a tradução.

<a name="security"></a>
<h2>Implicações de Segurança</h2>
Redirecionamento possui implicações de segurança. Fazer um furo no
firewall para permitir tráfego para a rede interna protegida cria um
risco de comprometimento da máquina interna. Caso o tráfego seja
transmitido para um servidor Web interno, por exemplo, e uma
vulnerabilidade seja descoberta no daemon do servidor ou em um
script CGI executado no servidor Web, a máquina pode ser comprometida
por um intruso na Internet. De lá, o intruso tem uma porta aberta para
a rede interna, em uma máquina que tem permissão de passar pelo
firewall.

<p>
Esses riscos podem ser minimizados mantendo-se os sistemas acessados
externamente confinados numa rede separada. Essa rede é geralmente
chamada de Zona Desmilitarizada (DMZ - "Demilitarized Zone") ou
Rede de Serviços Privada (PSN - "Private Service Network").
Dessa forma, caso o servidor Web seja comprometido, os efeitos podem ser
limitados à rede DMZ/PSN pela filtragem cuidadosa do tráfego que terá
permissão de entrar e sair da rede DMZ/PSN.

<a name="reflect"></a>
<h2>Redirecionamento e Reflexão</h2>
Geralmente regras de redirecionamento são usadas para transferir
pedidos de conexão da Internet para um servidor local com endereço IP
privado na rede interna, ou LAN, como:
<blockquote>
<tt>
server = 192.168.1.40<br>
<br>
rdr on $ext_if proto tcp from any to $ext_if port 80 -&gt; $server \<br>
&nbsp;&nbsp;&nbsp;port 80
</tt>
</blockquote>

<p>
Mas quando a regra de redirecionamento é testada por um cliente na LAN,
ela não funciona. O motivo é que as regras de redirecionamento se
aplicam apenas a pacotes que passam pela interface especificada (no
exemplo, a interface externa <tt>$ext_if</tt>).
Conectar-se ao endereço externo do firewall a partir de uma máquina na
LAN, contudo, não significa que os pacotes passarão por sua interface
externa. A pilha TCP/IP no firewall compara o endereço de destino do
pacote chegando com seus próprios endereços e apelidos e detecta
conexões para ela mesma tão logo que tenham passado pela interface
interna.
Esses pacotes não passam fisicamente pela interface externa, e a pilha
TCP/IP não simula essa passagem de forma alguma. Portanto, o PF nunca
vê esses pacotes na interface externa, e a regra de redirecionamento,
especificando a interface externa, não se aplica.

<p>
Adicionar uma segunda regra de redirecionamento para a interface interna
também não produz o efeito desejado. Quando um cliente local conecta-se
ao endereço externo do firewall, o pacote inicial do handshake TCP
atinge o firewall pela interface interna. A regra de redirecionamento
é aplicada e o endereço de destino é substituído pelo do servidor
interno. O pacote é transferido de volta pela interface interna e chega
ao servidor interno. Mas o endereço de origem no pacote não foi
traduzido, e ainda contém o endereço do cliente local, portanto o
servidor envia suas respostas diretamente ao cliente. O firewall nunca
vê as respostas, ficando sem chance de reverter a tradução
apropriadamente. O cliente então recebe respostas de um endereço
IP de onde ele nunca esperava, e por isso descarta os pacotes. O
handshake TCP falha e nenhuma conexão pode ser estabelecida.

<p>
Mas ainda assim, geralmente é necessário que os clientes na LAN se
conectem ao servidor interno da mesma forma que os clientes externos,
e que o façam de maneira transparente. Existem várias soluções
para esse problema:

<a name="splitdns"></a>
<h3>DNS "Split-Horizon"</h3>

<p>
É possível configurar servidores DNS para responder às pesquisas de
clientes locais de maneira diferente das pesquisas externas, de forma
que clientes locais receberão o endereço interno do servidor durante
a resolução de nomes. Eles, portanto, se conectam diretamente
ao servidor local, e o firewall não tem envolvimento. Isso reduz o
tráfego local, já que os pacotes não precisam passar pelo firewall.

<a name="sepnet"></a>
<h3>Mover o Servidor Para uma Rede Local Separada</h3>

<p>
Acrescentar mais uma interface de rede ao firewall e mover
o servidor local da rede cliente para uma rede dedicada (DMZ) permite
o redirecionamento de conexões dos clientes locais da mesma maneira
que o redirecionamento de conexões externas. O uso de redes separadas
traz diversas vantagens, incluindo melhora na segurança devido ao
isolamento do servidor das máquinas locais restantes. Caso o servidor
(que em nosso caso é acessível pela Internet) seja comprometido, ele não
terá acesso direto às máquinas locais porque todas as conexões devem
agora passar pelo firewall.

<a name="tcpproxy"></a>
<h3>Proxy TCP</h3>

<p>
Um proxy TCP genérico pode ser configurado no firewall, escutando na
porta a ser redirecionada ou recebendo conexões redirecionadas na
interface interna para a porta onde ele esteja escutando. Quando um
cliente local se conecta ao firewall, o proxy aceita a conexão,
estabelece uma segunda conexão com o servidor interno e transfere
dados entre as duas conexões.

<p>
Proxies simples podem ser criados usando-se
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=inetd&amp;sektion=8"
>inetd(8)</a> e
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=nc&amp;sektion=1"
>nc(1)</a>. A entrada no <tt>/etc/inetd.conf</tt> a seguir cria um
soquete que escuta no endereço de loopback (127.0.0.1) na porta 5000.
As conexões são encaminhadas ao servidor 192.168.1.10 na porta 80.
O redirecionamento é feito pelo usuário "proxy".
<blockquote>
<tt>
127.0.0.1:5000 stream tcp nowait proxy /usr/bin/nc nc -w \<br>
&nbsp;&nbsp;&nbsp;20 192.168.1.10 80
</tt>
</blockquote>

<p>
A regra de redirecionamento a seguir transfere conexões na porta 80,
na interface interna, para o proxy:
<blockquote>
<tt>
rdr on $int_if proto tcp from $int_net to $ext_if port 80 -&gt; \<br>
&nbsp;&nbsp;&nbsp;127.0.0.1 port 5000
</tt>
</blockquote>

<a name="rdrnat"></a>
<h3>Combinação de RDR e NAT</h3>

<p>
Com uma regra NAT adicional na interface interna, a tradução de
endereço que estava faltando no cenário acima pode ser remediada.
<blockquote>
<tt>
rdr on $int_if proto tcp from $int_net to $ext_if port 80 -&gt; \<br>
&nbsp;&nbsp;&nbsp;$server
<br>
no nat on $int_if proto tcp from $int_if to $int_net<br>
nat on $int_if proto tcp from $int_net to $server port 80 -&gt; \<br>
&nbsp;&nbsp;&nbsp;$int_if
</tt>
</blockquote>

<p>
Isso faz com que o pacote inicial do cliente seja traduzido novamente
quando retornar através da interface interna, substituindo o endereço
de origem do cliente pelo endereço interno do firewall. O servidor
interno responde para o firewall, que pode então reverter ambas
as regras de tradução NAT e RDR ao transferir o pacote para o cliente.
Essa construção é um tanto complexa, pois cria dois estados separados
para cada conexão refletida. Deve-se tomar muito cuidado para evitar
que a regra NAT atinja outro tráfego; por exemplo, conexões originadas
de máquinas externas (através de outros redirecionamentos) ou do próprio
firewall. Perceba que a regra <tt>rdr</tt> acima faz com que a pilha
TCP/IP receba pacotes na interface interna com um endereço de destino
dentro da rede interna.

<p>
De preferência, deve-se utilizar uma das soluções apresentadas
anteriormente.

<p>
[<a href="nat.html">Anterior: Tradução do Endereço de Rede (NAT)</a>]
[<a href="index.html">Conteúdo</a>]
[<a href="shortcuts.html">Próximo: Atalhos na Criação de
Conjuntos de Regras</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[voltar]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: rdr.html,v 1.28 ]<br>
$Translation: rdr.html,v 1.12 2009/10/18 16:52:52 alan Exp $<br>
-->
$OpenBSD: rdr.html,v 1.12 2009/10/19 09:39:59 ajacoutot Exp $
</small>

</body>
</html>
