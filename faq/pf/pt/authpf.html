<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Authpf: Shell de Usuário para Gateways de Autenticação</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003-2007 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../pt/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="ftp.html">Anterior: Problemas com FTP</a>]
[<a href="index.html">Conteúdo</a>]
[<a href="carp.html">Próximo: Redundância de Firewall com CARP
e pfsync</a>]

<h1><font color="#e00000">PF: Authpf: Shell de Usuário para Gateways
de Autenticação</font></h1>

<hr>

<h3>Conteúdo</h3>
<ul>
<li><a href="#intro">Introdução</a>
<li><a href="#config">Configuração</a>
	<ul>
        <li><a href="#enable">Habilitação do Authpf</a>
	<li><a href="#linkmain">Ligando o Authpf ao
            Conjunto de Regras Principal</a>
	<li><a href="#loadrules">Configuração de Regras Carregadas</a>
	<li><a href="#acl">Listas de Controle de Acesso</a>
        <li><a href="#message">Mostrando uma Mensagem de
            Início de Sessão</a>
	<li><a href="#shell">Definindo o Authpf como um
            Shell do Usuário</a>
	</ul>
<li><a href="#loginclass">Criação de uma Classe de Início de Sessão
    authpf</a>
<li><a href="#wholog">Verificando Quem está em Sessão</a>
<li><a href="#example">Exemplo</a>
</ul>

<hr>

<a name="intro"></a>
<h2>Introdução</h2>
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=authpf&amp;sektion=8&amp;manpath=OpenBSD+4.6"
>Authpf(8)</a> é um shell de usuário para gateways de autenticação.
Um gateway de autenticação é como um gateway de rede normal (também
conhecido como um roteador), exceto pelo fato dos usuários precisarem
primeiro se autenticar no gateway antes de poderem passar tráfego por
ele. Quando um shell de usuário é definido como
<tt>/usr/sbin/authpf</tt> (ou seja, em vez de definir o shell como
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ksh&amp;sektion=1"
>ksh(1)</a>,
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=csh&amp;sektion=1"
>csh(1)</a>, etc.), e esse usuário inicia sessão por SSH, o authpf faz as
alterações necessárias no conjunto de regras ativas do
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pf&amp;sektion=4&amp;manpath=OpenBSD+4.6"
>pf(4)</a> para permitir que o tráfego do usuário passe pelas regras de
filtragem e/ou seja alterado usando Tradução do Endereço de Rede (NAT)
ou redirecionamento. Assim que o usuário encerrar a sessão ou sua sessão
for desconectada, o authpf remove quaisquer regras carregadas para o
usuário e derruba quaisquer conexões, com o estado mantido na
tabela de estados, que o usuário possa ter aberto. Por isso a habilidade
do usuário de passar tráfego através do gateway somente existe enquanto
sua conexão SSH estiver ativa.

<p>
O authpf carrega regras de filtragem/NAT de usuários em uma única
<a href="anchors.html">âncora</a>.
A âncora é nomeada combinando o nome de usuário UNIX e o ID de processo
(PID - "Process ID") do authpf em um formato
"<tt>nome_de_usuário(PID)</tt>".
Cada âncora de usuário é guardada dentro da âncora <tt>authpf</tt>, a
qual é ancorada no conjunto de regras principal.
O "caminho da âncora totalmente qualificado" então torna-se:

<blockquote>
<tt>
<i>conjunto_de_regras_principal</i>/authpf/<i>nome_de_usuário</i>(<i>PID</i>)
</tt>
</blockquote>

<p>
As regras que o authpf carrega podem ser configuradas por usuário ou
globalmente.

<p>
Exemplos de uso do authpf incluem:
<ul>
<li>Exigir a autenticação do usuário antes de permitir o acesso
    à Internet.
<li>Garantir a certos usuários -- como administradores -- acesso
    à partes restritas da rede.
<li>Permitir o acesso ao restante da rede ou à Internet em um segmento
    de rede sem fio apenas a usuários conhecidos.
<li>Permitir o acesso de pessoas que trabalham em casa, viajantes, etc.,
    aos recursos na rede da empresa. Usuários fora do escritório não
    apenas podem acessar a rede da empresa, mas também podem ser
    redirecionados para recursos em particular (por exemplo, seu próprio
    desktop) baseando-se no nome de usuário com que eles se autenticam.
<li>Em lugares como bibliotecas ou outros estabelecimentos com
    terminais públicos para Internet, o PF pode ser configurado para
    permitir acesso limitado para visitantes. O authpf pode então ser
    utilizado para prover acesso completo a usuários registrados.
</ul>

<p>
O authpf registra o nome de usuário e endereço IP de cada usuário que se
autentica, bem como o horário de início e fim de sua sessão, via
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=syslogd&amp;sektion=8"
>syslogd(8)</a>. Utilizando essa informação, um administrador pode
determinar quem estava em sessão e quando, e também pode calcular o
tráfego utilizado por cada usuário, podendo fazer cobranças com base
nesses dados.

<a name="config"></a>
<h2>Configuração</h2>
Os passos básicos necessários para configurar o authpf são descritos
aqui.
Para uma descrição completa da configuração do authpf, por favor
consulte a
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=authpf&amp;sektion=8&amp;manpath=OpenBSD+4.6"
>página de manual do authpf</a>.

<a name="enable"></a>
<h3>Habilitação do Authpf</h3>

<p>
O authpf não é executado se o arquivo de configuração
<tt>/etc/authpf/authpf.conf</tt> não estiver presente.
Mesmo se o arquivo estiver vazio (tamanho zero), deve estar presente
ou o authpf termina sua execução imediatamente após um usuário se
autenticar com sucesso.

<p>
As seguintes diretivas de configuração podem ser colocadas no
<tt>authpf.conf</tt>:

<ul>
<li><tt>anchor=<i>nome</i></tt> - Usa o nome de
    <a href="anchors.html">âncora</a> especificado em vez de
    "authpf".
<li><tt>table=<i>nome</i></tt> - Usa o nome de
    <a href="tables.html">tabela</a> especificado em vez de
    "authpf_users".
</ul>

<a name="linkmain"></a>
<h3>Ligando o Authpf ao Conjunto de Regras Principal</h3>
O authpf é ligado ao conjunto de regras principal utilizando-se de
regras <tt>anchor</tt>:
<blockquote>
<tt>
nat-anchor "authpf/*"<br>
rdr-anchor "authpf/*"<br>
binat-anchor "authpf/*"<br>
anchor "authpf/*"<br>
</tt>
</blockquote>

<p>
O lugar onde regras <tt>anchor</tt> são colocadas dentro do conjunto de
regras é onde o PF sai do conjunto de regras principal para avaliar as
regras do authpf. Não é necessário que todas as quatro regras
<tt>anchor</tt> estejam presentes; por exemplo, caso o authpf não seja
configurado para carregar regras <tt>nat</tt>, a regra
<tt>nat-anchor</tt> pode ser omitida.

<a name="loadrules"></a>
<h3>Configuração de Regras Carregadas</h3>
O authpf carrega suas regras a partir de um destes arquivos:
<ul>
<li><tt>/etc/authpf/users/$USER/authpf.rules</tt>
<li><tt>/etc/authpf/authpf.rules</tt>
</ul>

<p>
O primeiro arquivo contém regras que são carregadas apenas quando o
usuário <tt>$USER</tt> (que é substituído pelo nome do usuário)
inicia sessão. A configuração de regras por usuário é utilizada quando
um usuário em específico -- como um administrador -- exige um conjunto
de regras diferente do padrão. O segundo arquivo contém as regras padrão
que são carregadas para quaisquer usuários que não possuam seu próprio
arquivo <tt>authpf.rules</tt>. Se o arquivo específico do usuário
existir, ele sobrescreve as regras do arquivo padrão. Pelo menos
um dos arquivos deve existir, caso contrário o authpf não funciona.

<p>
Regras de filtragem e tradução possuem a mesma sintaxe como em qualquer
outro conjunto de regras PF, com uma exceção: o authpf permite o uso de
duas macros predefinidas:
<ul>
<li><tt>$user_ip</tt> - o endereço IP do usuário em sessão
<li><tt>$user_id</tt> - o nome de usuário do usuário em sessão
</ul>

<p>
É prática recomendada usar a macro <tt>$user_ip</tt> para permitir
tráfego através do gateway vindo apenas do computador do usuário
autenticado.

<p>
Em adição à macro <tt>$user_ip</tt>, o authpf faz uso da tabela
<tt>authpf_users</tt> (se existir) para armazenar o endereço IP de todos
os usuários autenticados. Tenha certeza de definir a tabela antes de
usá-la:

<blockquote>
<tt>
table &lt;authpf_users&gt; persist<br>
pass in on $ext_if proto tcp from &lt;authpf_users&gt; \<br>
&nbsp;&nbsp;&nbsp;&nbsp;to port  smtp flags S/SA keep state
</tt>
</blockquote>

<p>
Essa tabela somente deve ser usada em regras que se pretende aplicar
a todos os usuários autenticados.

<a name="acl"></a>
<h3>Listas de Controle de Acesso</h3>
Usuários podem ser impedidos de usar o authpf criando-se um arquivo no
diretório <tt>/etc/authpf/banned/</tt> e nomeando-o com o nome de
usuário que deve ter o acesso negado. O conteúdo desse arquivo será
mostrado ao usuário antes que authpf o desconecte. Isso fornece uma
maneira simples de notificar o usuário do porquê que seu acesso não
é permitido e a quem contatar para ter o acesso liberado novamente.

<p>
De outro modo, é possível também permitir o acesso apenas a usuários
específicos colocando seus nomes de usuário no arquivo
<tt>/etc/authpf/authpf.allow</tt>. Se o arquivo
<tt>/etc/authpf/authpf.allow</tt> não existe ou seu conteúdo for um
"<tt>*</tt>", então o authpf permite o acesso a qualquer usuário que
conseguir iniciar sessão via SSH, desde que não tenha sido
explicitamente banido.

<p>
Caso o authpf não consiga determinar se um nome de usuário tem ou não
permissão de acesso, ele mostra uma breve mensagem e então
desconecta o usuário. Uma entrada em <tt>/etc/authpf/banned/</tt>
sempre sobrescreve uma entrada em <tt>/etc/authpf/authpf.allow</tt>.

<a name="message"></a>
<h3>Mostrando uma Mensagem de Início de Sessão</h3>

<p>
Sempre que um usuário se autentica com sucesso no authpf, uma saudação
que indica que o usuário está autenticado é mostrada.

<blockquote>
<tt>
Hello charlie. You are authenticated from host "64.59.56.140"
</tt>
</blockquote>

<p>
Essa mensagem pode ser suplementada colocando-se uma mensagem
personalizada no <tt>/etc/authpf/authpf.message</tt>.
O conteúdo desse arquivo será mostrado depois da mensagem de bem-vindo
padrão.

<a name="shell"></a>
<h3>Definindo o Authpf como um Shell do Usuário</h3>
Para o authpf funcionar, ele deve ser definido como shell de início de
sessão do usuário. Quando o usuário se autenticar no
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sshd&amp;sektion=8"
>sshd(8)</a>, o authpf será executado como o shell do usuário.
Ele então verifica se o usuário tem permissão de usar o authpf, carrega
as regras do arquivo apropriado, etc.

<p>
Existem algumas formas de se definir o authpf como um shell do usuário:
<ol>
<li>Manualmente para cada usuário, usando
    <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=chsh&amp;sektion=1"
    >chsh(1)</a>,
    <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=vipw&amp;sektion=8"
    >vipw(8)</a>,
    <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=useradd&amp;sektion=8"
    >useradd(8)</a>,
    <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=usermod&amp;sektion=8"
    >usermod(8)</a>, etc.
<li>Colocando usuários em uma classe de início de sessão e alterando
    a opção <tt>shell</tt> da classe em
    <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=login.conf&amp;sektion=5"
    ><tt>/etc/login.conf</tt></a>.
</ol>

<a name="loginclass"></a>
<h2>Criação de uma Classe de Início de Sessão authpf</h2>
Ao utilizar o authpf em um sistema que tem contas de usuários normais
e contas de usuários authpf, pode ser útil usar uma
classe de início de sessão separada para os usuários authpf.
Isso permite que certas mudanças àquelas contas sejam feitas
globalmente, e também permite que políticas diferentes sejam
colocadas em contas normais e contas authpf.
Alguns exemplos de quais políticas podem ser configuradas:

<ul>
<li><b>shell</b> - Especifica um shell de início de sessão do usuário.
    Isso pode ser usado para forçar o shell do usuário para
    <tt>authpf</tt>, independente da entrada no banco de dados
    <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=passwd&amp;sektion=5"
    >passwd(5)</a>.
<li><b>welcome</b> - Especifica qual arquivo
    <a href="http://www.openbsd.org/cgi-bin/man.cgi?query=motd&amp;sektion=5"
    >motd(5)</a> mostrar quando um usuário iniciar sessão.
    Isso é útil para mostrar mensagens que são relevantes somente para
    usuários authpf.
</ul>

<p>
Classes de início de sessão são criadas no arquivo
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=login.conf&amp;sektion=5"
>login.conf(5)</a>.
O OpenBSD possui uma classe de início de sessão definida como:

<blockquote>
<tt>
authpf:\<br>
&nbsp;&nbsp;&nbsp;&nbsp;:welcome=/etc/motd.authpf:\<br>
&nbsp;&nbsp;&nbsp;&nbsp;:shell=/usr/sbin/authpf:\<br>
&nbsp;&nbsp;&nbsp;&nbsp;:tc=default:
</tt>
</blockquote>

<p>
Os usuários são designados para uma classe de início de sessão através
da edição do campo <tt>class</tt> da entrada do usuário no
banco de dados passwd(5).
Uma maneira de se fazer isso é com o comando
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=chsh&amp;sektion=1"
>chsh(1)</a>.


<a name="wholog"></a>
<h2>Verificando Quem está em Sessão</h2>
Assim que um usuário inicia sessão e o authpf ajusta as regras PF,
ele também altera o título do processo para mostrar o nome e o
endereço IP do usuário em sessão:
<pre>
    # ps -ax | grep authpf
    23664 p0  Is+     0:00.11 -authpf: charlie@192.168.1.3 (authpf)
</pre>

<p>
Aqui o usuário <tt>charlie</tt> iniciou sessão a partir da máquina
192.168.1.3.
Ao enviar um sinal SIGTERM ao processo authpf, o usuário pode ser
forçado a encerrar sua sessão. O authpf remove quaisquer regras
inseridas para o usuário e derruba todas conexões, com o estado mantido
na tabela de estados, que esse usuário tiver aberto.
<pre>
    # kill -TERM 23664
</pre>

<a name="example"></a>
<h2>Exemplo</h2>
O authpf está sendo usado em um gateway OpenBSD para autenticar usuários
em uma rede sem fio que é parte de uma grande rede em um campus.
Assim que o usuário tiver se autenticado, assumindo que não esteja na
lista de banidos, ele terá permissão de abrir conexões SSH e navegar na
Web (incluindo sítios Web seguros), além de poder acessar os servidores
DNS do campus.

<p>
O arquivo <tt>/etc/authpf/authpf.rules</tt> contém as seguintes
regras:<br>
<br>

<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
wifi_if = "wi0"

pass in quick on $wifi_if proto tcp from $user_ip to port { ssh, http, \
   https } flags S/SA keep state
</pre>
</td></tr>
</table>

<p>
O usuário administrativo <tt>charlie</tt> deve ter acesso aos
servidores SMTP e POP3, além de poder navegar na Web e usar
SSH. As regras a seguir estão definidas no arquivo
<tt>/etc/authpf/users/charlie/authpf.rules</tt>:<br>
<br>

<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
wifi_if = "wi0"
smtp_server = "10.0.1.50"
pop3_server = "10.0.1.51"

pass in quick on $wifi_if proto tcp from $user_ip to $smtp_server \
   port smtp flags S/SA keep state
pass in quick on $wifi_if proto tcp from $user_ip to $pop3_server \
   port pop3 flags S/SA keep state
pass in quick on $wifi_if proto tcp from $user_ip to port { ssh, http, \
   https } flags S/SA keep state
</pre>
</td></tr>
</table>

<p>
O conjunto de regras principal -- localizado em <tt>/etc/pf.conf</tt> --
é configurado a seguir:<br>
<br>

<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
# Macros
wifi_if = "wi0"
ext_if  = "fxp0"
dns_servers = "{ 10.0.1.56, 10.0.2.56 }"

table &lt;authpf_users&gt; persist

scrub in all

# Filtragem
block drop all

pass out quick on $ext_if inet proto tcp from \
   { $wifi_if:network, $ext_if } flags S/SA modulate state
pass out quick on $ext_if inet proto { udp, icmp } from \
   { $wifi_if:network, $ext_if } keep state

pass in quick on $wifi_if inet proto tcp from $wifi_if:network to $wifi_if \
   port ssh flags S/SA keep state

pass in quick on $wifi_if inet proto { tcp, udp } from &lt;authpf_users&gt; \
   to $dns_servers port domain keep state
anchor "authpf/*" in on $wifi_if
</pre>
</td></tr>
</table>

<p>
O conjunto de regras é bem simples e faz o seguinte:
<ul>
<li>Bloqueia tudo (negar por padrão).
<li>Permite tráfego TCP, UDP e ICMP saindo na interface externa,
    vindo da rede sem fio e do próprio gateway.
<li>Permite tráfego SSH de entrada vindo da rede sem fio e
    destinado ao próprio gateway. Essa regra é necessária para
    permitir que os usuários possam iniciar sessão.
<li>Permite requisições DNS de entrada vindas de todos os usuários
    authpf autenticados para servidores DNS do campus.
<li>Cria uma âncora "authpf" para tráfego de entrada vindo pela
    interface da rede sem fio.
</ul>

<p>
A ideia por trás do conjunto de regras principal é bloquear tudo e
permitir a passagem da menor quantidade possível de tráfego.
O tráfego saindo pela interface externa é liberado, mas é bloqueada pela
política negar por padrão a entrada na interface sem fio.
Uma vez autenticado, é permitido ao tráfego do usuário atravessar a
interface sem fio e seguir através do gateway para o resto da rede.
A palavra-chave <tt>quick</tt> é usada de forma que o PF não precise
avaliar cada conjunto de regras nomeado quando uma nova conexão
atravessa o gateway.

<p>
[<a href="ftp.html">Anterior: Problemas com FTP</a>]
[<a href="index.html">Conteúdo</a>]
[<a href="carp.html">Próximo: Redundância de Firewall com CARP
e pfsync</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[voltar]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: authpf.html,v 1.26 ]<br>
$Translation: authpf.html,v 1.14 2009/10/18 16:52:52 alan Exp $<br>
-->
$OpenBSD: authpf.html,v 1.14 2009/10/19 09:39:58 ajacoutot Exp $
</small>

</body>
</html>
