<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>PF: Exemplo: Firewall para Casa ou Pequeno Escritório</title>
<link rev="made" href="mailto:www@openbsd.org">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="resource-type" content="document">
<meta name="description"   content="the OpenBSD FAQ page">
<meta name="keywords"      content="openbsd,faq,pf">
<meta name="distribution"  content="global">
</head>

<!--
Copyright (c) 2003, 2004 Joel Knight <enabled@myrealbox.com>

Permission to use, copy, modify, and distribute this documentation for
any purpose with or without fee is hereby granted, provided that the
above copyright notice and this permission notice appear in all copies.

THE DOCUMENTATION IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL
WARRANTIES WITH REGARD TO THIS DOCUMENTATION INCLUDING ALL IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE
AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL
DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR
PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER
TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS DOCUMENTATION
-->

<body bgcolor="#ffffff" text="#000000">
<!-- Passes validator.w3.org, please keep it this way;
please, use a max of 72 chars per line -->

<a href="../../../pt/index.html">
<img alt="[OpenBSD]" height=30 width=141 src="../../../images/smalltitle.gif" border="0">
</a>
<p>
[<a href="carp.html">Anterior: Redundância de Firewall com CARP
e pfsync</a>]
[<a href="index.html">Conteúdo</a>]

<p>
<h1><font color="#e00000">PF: Exemplo: Firewall para Casa ou Pequeno
Escritório</font></h1>
<hr>

<h3>Conteúdo</h3>
<ul>
<li><a href="#scenario">O Cenário</a>
	<ul>
	<li><a href="#network">A Rede</a>
	<li><a href="#objective">O Objetivo</a>
	<li><a href="#prep">Preparação</a>
	</ul>
<li><a href="#ruleset">O Conjunto de Regras</a>
	<ul>
	<li><a href="#macros">Macros</a>
	<li><a href="#options">Opções</a>
	<li><a href="#scrub">Scrub</a>
	<li><a href="#nat">Tradução do Endereço de Rede (NAT)</a>
	<li><a href="#rdr">Redirecionamento</a>
	<li><a href="#filter">Regras de Filtragem</a>
	</ul>
<li><a href="#allrules">O Conjunto de Regras Completo</a>
</ul>

<hr>

<a name="scenario"></a>
<h2>O Cenário</h2>
Neste exemplo, o PF está em execução em uma máquina OpenBSD agindo como
firewall e gateway NAT para uma pequena rede em casa ou no escritório. O
objetivo geral é prover acesso à Internet para a rede interna e acesso
limitado ao firewall de conexões provenientes da Internet, e ainda
disponibilizar para acesso externo um servidor Web localizado na rede
interna. Este documento guia-o através da criação de um conjunto de
regras para esse fim.

<a name="network"></a>
<h3>A Rede</h3>
A rede está configurada da seguinte forma:

<pre>

  [ COMP1 ]    [ COMP3 ]
      |            |
   ---+------+-----+------- xl0 [ OpenBSD ] fxp0 -------- ( Internet )
             |
         [ COMP2 ]

</pre>

<p>
Existem vários computadores na rede interna; o diagrama mostra apenas
três, mas o número real é irrelevante. Esses computadores são
estações de trabalho usadas para navegar na Internet, ler
mensagens de correio eletrônico, usar programas de bate-papo virtual,
etc., exceto COMP3, que também roda um pequeno servidor Web.
A rede interna usa o bloco de rede 192.168.0.0 / 255.255.255.0.

<p>
O firewall OpenBSD é um Celeron 300 com duas placas de rede:
uma 3com 3c905B (<tt>xl0</tt>) e uma Intel EtherExpress Pro/100
(<tt>fxp0</tt>).
Ele possui uma conexão a cabo com a Internet e faz NAT para compartilhar
o acesso com a rede interna. O endereço IP na interface externa é
atribuído dinamicamente pelo Provedor de Acesso à Internet.

<a name="objective"></a>
<h3>O Objetivo</h3>
Os Objetivos são:
<ul>
<li>Prover acesso irrestrito à Internet para a rede interna.
<li>Usar "negar por padrão" como política padrão do conjunto de regras.
<li>Permitir o seguinte tráfego vindo da Internet para o firewall:
	<ul>
	<li>SSH (porta TCP 22): será utilizado para manutenção
            remota do firewall.
	<li>Auth/Ident (porta TCP 113): utilizado por alguns
	    serviços como SMTP e IRC.
	<li>Requisições de Eco ICMP: o tipo de pacote ICMP usado pelo
            comando <a
            href="http://www.openbsd.org/cgi-bin/man.cgi?query=ping&amp;sektion=8"
            >ping(8)</a>.
	</ul>
<li>Redirecionar tentativas de conexão na porta TCP 80 (que são
    tentativas de conexão a um servidor Web) para o computador COMP3.
    E também permitir tráfego TCP na porta 80 destinado a COMP3 através
    do firewall.
<li>Registrar as estatísticas de filtragem na interface externa.
<li>Por padrão, responder os pacotes bloqueados com um pacote TCP RST
    ou ICMP de Inalcançável.
<li>Tornar o conjunto de regras o mais simples possível, para facilitar
    a manutenção.</ul>

<a name="prep"></a>
<h3>Preparação</h3>
Este documento assume que a máquina OpenBSD tenha sido corretamente
configurada para funcionar como roteador, incluindo a configuração de
endereços IP, conectividade com a Internet e a definição das variáveis
do
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=sysctl&amp;sektion=3"
>sysctl(3)</a> <tt>net.inet.ip.forwarding</tt> e/ou
<tt>net.inet6.ip6.forwarding</tt> para "<tt>1</tt>".
Também é necessário que você tenha ativado o PF usando
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pfctl&amp;sektion=8&amp;manpath=OpenBSD+4.6"
>pfctl(8)</a> ou definindo a variável apropriada em
<tt>/etc/rc.conf.local</tt>.

<a name="ruleset"></a>
<h2>O Conjunto de Regras</h2>
A seguir um passo a passo através do conjunto de regras que realizarão
os objetivos descritos acima.

<a name="macros"></a>
<h3>Macros</h3>
As seguintes macros são definidas para facilitar a leitura e manutenção
do conjunto de regras:
<blockquote>
<tt>
ext_if="fxp0"<br>
int_if="xl0"<br>
<br>
tcp_services = "{ 22, 113 }"<br>
icmp_types = "echoreq"<br>
<br>
comp3="192.168.0.3"
</tt>
</blockquote>

<p>
As primeiras duas linhas definem as interfaces de rede onde a filtragem
acontecerá.
Definindo elas aqui, se precisarmos mover esse sistema para outra
máquina com hardware diferente, podemos alterar apenas essas duas
linhas e o resto das regras continuarão utilizáveis.
A terceira e quarta linha listam os números de portas TCP dos serviços
que serão abertos para a Internet (SSH e ident/auth) e os tipos de
pacotes ICMP que terão permissão de alcançar a máquina do firewall.
Finalmente, a última linha define o endereço IP de COMP3.

<p>
<b>Nota</b>: Caso a conexão com a Internet necessite do
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=pppoe&amp;sektion=8"
>PPPoE</a>, então filtragem e NAT devem acontecer na interface
<tt>tun0</tt> e <i>não</i> em <tt>fxp0</tt>.

<a name="options"></a>
<h3>Opções</h3>
As duas opções seguintes são responsáveis pela definição da resposta
padrão para regras de filtragem <tt>block</tt> e pelo "ativamento" do
registro de estatísticas para a interface externa:
<blockquote>
<tt>
set block-policy return<br>
set loginterface $ext_if
</tt>
</blockquote>

<p>
Todo sistema Unix possui uma interface "loopback".
Esta é uma interface de rede virtual que é utilizada por aplicativos
para conversarem entre si dentro do sistema.
No OpenBSD, a interface loopback é a
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=lo&amp;sektion=4"
>lo(4)</a>.
É recomendado desabilitar qualquer filtragem nas interfaces loopback;
use <a href="options.html#skip">set skip</a> para fazer isso.
<blockquote>
<tt>
set skip on lo
</tt>
</blockquote>
Note que nós estamos usando skip no grupo de interface <tt>lo</tt>
inteiro, dessa maneira nós podemos mais tarde adicionar interfaces
loopback adicionais e não precisamos nos preocupar em alterar essa
parte do nosso arquivo de regras.

<a name="scrub"></a>
<h3>Scrub</h3>
Não há razão para não utilizar "scrubbing", recomendado para todo
tráfego de entrada; portanto, aplicamos a regra com uma simples linha:
<blockquote>
<tt>
match in all scrub (no-df)
</tt>
</blockquote>

<a name="nat"></a>
<h3>Tradução do Endereço de Rede (NAT)</h3>
Para fazer NAT para toda a rede interna, a seguinte regra <tt>nat</tt>
é usada:
<blockquote>
<tt>
nat on $ext_if from !($ext_if) to any -&gt; ($ext_if)
</tt>
</blockquote>

<p>
O "<tt>!($ext_if)</tt>" poderia ser facilmente substituído por
"<tt>$int_if</tt>" nesse caso, mas caso você tenha múltiplas interfaces
internas, você precisaria ter que adicionar mais regras NAT, ao passo
que, com essa estrutura, a NAT será feita em todas as interfaces
protegidas.

<p>
Já que o endereço IP da interface externa é atribuído dinamicamente,
parêntesis devem ser colocados em volta da interface de tradução,
assim o PF notará qualquer alteração no endereço.

<p>
Como queremos que o proxy FTP funcione, adicionaremos uma
<a href="anchors.html">âncora</a> NAT também:

<blockquote>
<tt>
nat-anchor "ftp-proxy/*"
</tt>
</blockquote>


<a name="rdr"></a>
<h3>Redirecionamento</h3>
As primeiras regras de redirecionamento são necessárias para o
<a href="http://www.openbsd.org/cgi-bin/man.cgi?query=ftp-proxy&amp;sektion=8&amp;manpath=OpenBSD+4.6"
>ftp-proxy(8)</a>,
assim os clientes FTP na rede interna local podem se conectar
a servidores FTP na Internet.
<blockquote>
<tt>
rdr-anchor "ftp-proxy/*"<br>
rdr on $int_if proto tcp from any to any port 21 -&gt; 127.0.0.1 port 8021
</tt>
</blockquote>

<p>
Note que essa regra somente captura conexões destinadas à porta 21.
Caso usuários se conectem a servidores FTP em outras portas,
então uma lista deve ser utilizada para especificar as portas
de destino, por exemplo: <tt>from any to any port { 21, 2121 }</tt>.

<p>
A última regra de redirecionamento captura qualquer tentativa de conexão
vinda da Internet em direção à porta TCP 80 no firewall.
Tentativas legítimas de conexão nessa porta serão de usuários tentando
acessar o servidor Web da rede.
Essas tentativas de conexão devem ser redirecionadas para COMP3:

<blockquote>
<tt>
rdr on $ext_if proto tcp from any to any port 80 -&gt; $comp3
</tt>
</blockquote>

<a name="filter"></a>
<h3>Regras de Filtragem</h3>
Agora as regras de filtragem. Começando com negar por padrão:
<blockquote>
<tt>
block in<br>
</tt>
</blockquote>

<p>
Nesse ponto todo o tráfego tentando entrar em uma interface será
bloqueado, mesmo os da interface de rede interna.
As regras seguintes abrem o firewall de acordo com os objetivos
descritos acima, e abrem também quaisquer interfaces virtuais que se
façam necessárias.

<p>
Tenha em mente que o pf pode bloquear o tráfego que entra e sai de uma
interface. Para simplificar sua vida, você pode escolher fazer a
filtragem de tráfego em apenas uma direção em vez de bloquear entrada
e saída. Em nosso caso optamos por filtrar o tráfego de entrada,
mas uma vez filtrada a entrada não tentaremos obstruir sua
saída, portanto faremos o seguinte:

<blockquote>
<tt>
pass out keep state
</tt>
</blockquote>

<p>
Precisamos ter uma <a href="anchors.html">âncora</a> para o
ftp-proxy(8):
<blockquote>
<tt>
anchor "ftp-proxy/*"
</tt>
</blockquote>

É bom usar também a
<a href="filter.html#antispoof">proteção contra falsificações</a>:
<blockquote>
<tt>
antispoof quick for { lo $int_if }
</tt>
</blockquote>

<p>
Agora abrimos as portas usadas pelos serviços que estarão disponíveis
para a Internet. Primeiro, o tráfego que é destinado ao firewall em si:

<blockquote>
<tt>
pass in on $ext_if inet proto tcp from any to ($ext_if) \<br>
&nbsp;&nbsp;&nbsp;port $tcp_services flags S/SA keep state
</tt>
</blockquote>

<p>
Especificar as portas na macro <tt>$tcp_services</tt> simplifica a
abertura de serviços adicionais para a Internet através da simples
edição da macro e recarregamento do conjunto de regras.
Serviços UDP também podem ser abertos com a criação de uma macro
<tt>$udp_services</tt> e a adição de uma regra de filtragem, similar a
anterior, que especifique <tt>proto udp</tt>.

<p>
Além de ter uma regra <tt>rdr</tt> que redireciona o tráfego do servidor
Web para COMP3, ainda PRECISAMOS permitir a passagem do tráfego através
do firewall:
<blockquote>
<tt>
pass in on $ext_if inet proto tcp from any to $comp3 port 80 \<br>
&nbsp;&nbsp;&nbsp;&nbsp;flags S/SA synproxy state
</tt>
</blockquote>

<p>
Para aumentar um pouco a segurança, faremos uso do
<a href="filter.html#synproxy">Proxy de Pacotes TCP SYN</a>
com o intuito de proteger o servidor Web.

<p>
Tráfego ICMP precisa ser permitido:
<blockquote>
<tt>
pass in inet proto icmp all icmp-type $icmp_types keep state
</tt>
</blockquote>

<p>
Similar à macro <tt>$tcp_services</tt>, a macro <tt>$icmp_types</tt>
pode ser facilmente editada para alterar os tipos de pacotes ICMP que
terão permissão de passar pelo firewall.
Note que essa regra se aplica a todas as interfaces de rede.

<p>
Agora o tráfego deve passar "de" e "para" a interface interna.
Assumiremos que os usuários da rede interna sabem o que estão fazendo
e não nos causarão problemas. Essa não é necessariamente uma suposição
válida; um conjunto de regras muito mais restritivo pode ser apropriado
para muitos ambientes.
<blockquote>
<tt>
pass in quick on $int_if
</tt>
</blockquote>

<p>
Tráfego TCP, UDP e ICMP pode sair do firewall com destino à Internet
de acordo com a linha "<tt>pass out keep state</tt>" anterior.
A informação de estado das conexões é mantida de forma que pacotes que
retornam passarão pelo firewall.

<a name="allrules"></a>
<h2>O Conjunto de Regras Completo</h2>
<table border=0 width="650">
<tr><td nowrap bgcolor="#EEEEEE">
<pre>
# Macros
ext_if="fxp0"
int_if="xl0"

tcp_services="{ 22, 113 }"
icmp_types="echoreq"

comp3="192.168.0.3"

# Opções
set block-policy return
set loginterface $ext_if

set skip on lo

# Scrub
match in all scrub (no-df)

# Nat/rdr
nat on $ext_if from !($ext_if) -> ($ext_if:0)
nat-anchor "ftp-proxy/*"
rdr-anchor "ftp-proxy/*"

rdr pass on $int_if proto tcp to port ftp -> 127.0.0.1 port 8021
rdr on $ext_if proto tcp from any to any port 80 -> $comp3

# Regras de filtragem
block in

pass out keep state

anchor "ftp-proxy/*"
antispoof quick for { lo $int_if }

pass in on $ext_if inet proto tcp from any to ($ext_if) \
   port $tcp_services flags S/SA keep state

pass in on $ext_if inet proto tcp from any to $comp3 port 80 \
    flags S/SA synproxy state

pass in inet proto icmp all icmp-type $icmp_types keep state

pass in quick on $int_if
</pre>
</td></tr>
</table>

<p>
[<a href="carp.html">Anterior: Redundância de Firewall com CARP
e pfsync</a>]
[<a href="index.html">Conteúdo</a>]

<p>
<hr>
<a href="index.html"><img height="24" width="24" src="../../../images/back.gif" border="0" alt="[voltar]"></a>
<a href="mailto:www@openbsd.org">www@openbsd.org</a>
<br>
<small>
<!--
Originally [OpenBSD: example1.html,v 1.39 ]<br>
$Translation: example1.html,v 1.14 2009/10/18 16:52:52 alan Exp $<br>
-->
$OpenBSD: example1.html,v 1.14 2009/10/19 09:39:59 ajacoutot Exp $
</small>

</body>
</html>
